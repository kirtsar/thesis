\chapter{Алгоритмические и вычислительные аспекты}\label{sec:algo}

    В настоящей главе рассматриваются некоторые прикладные вопросы, связанные с правильными семействами:
    \begin{itemize}
        \item в разделе~\ref{sec:fpe} предлагается к рассмотрению один алгоритм шифрования, сохраняющего формат, основанный на квазигрупповых сдвигах в квазигруппах, порожденных правильными семействами булевых функций,
        \item раздел~\ref{sec:fastproper} посвящен рассмотрению одного улучшения \textquote{наивного} алгоритма распознавания правильности,
        \item в разделе~\ref{sec:representatives} приводится один алгоритм построения системы представителей относительно действия группы изометрий (см. раздел~\ref{sec:proper_automorph}),
        \item в разделе~\ref{sec:experimental} приведены результаты численных экспериментов (количество булевых правильных семейств в некоторых классах, число ассоциативных троек).
    \end{itemize}

    Результаты главы ранее были опубликованы в~\cite{fpe22, sibecrypt23}.


\section{Шифрование, сохраняющее формат}
\label{sec:fpe}
    Шифрование, сохраняющее формат (FPE, Format preserving encryption~\cite{bellare2009format}, далее $\fpe$-схема)~--- алгоритм, позволяющий зашифровывать сообщения из произвольного конечного множества $\Dom$ таким образом, что результат зашифрования также лежит в множестве $\Dom$.
    Такой тип алгоритмов довольно востребован на практике, о чем свидетельствует большое количество статей и предложений, рассматривающих стойкость таких криптопримитивов~\cite{bellare2009format, lee2015format, NIST16}.
    При этом подобные алгоритмы часто подвергаются специфическим атакам, связанным, в том числе, и с возможным относительно малым размером области определения (см.~\cite{hoang2018curse, amon2021three}).
    Известны <<доказуемо стойкие>> (см.~\cite{katz2020introduction}) алгоритмы как для очень малых ($ \lvert \Dom \rvert \approx 2^{10}$), так и для очень больших областей определения (размер которых приближается к размеру области определения стандартных блочных шифров, либо превышает их, см. т.н. wide-block encryption), в то время как для <<средних>> областей определения всё ещё не существует одного предпочтительного подхода.
    В этом разделе мы рассмотрим один возможный подход к построению $\fpe$-схем, основанный на квазигрупповых операциях.

\subsection{Общее описание $\fpe$-схем}
    $\fpe$-схемы позволяют зашифровывать тексты с заданным форматом (6 десятичных цифр, номер кредитной карты, СНИЛС) таким образом, чтобы зашифрованное сообщение имело бы тот же формат, что и исходное. 
    Указанное свойство желательно, например, при шифровании баз данных, где поля записей имеют строго предписанный формат.
    Формализация данного требования выглядит следующим образом.
    \begin{definition}
        $\fpe$-схема~--- это тройка (вероятностных) алгоритмов $(\gen, \enc, \dec)$:
        \begin{itemize}
            \item (вероятностный) алгоритм генерации ключа $\gen$: на вход принимает пустую строку и возвращает ключ $K \in Keys$;
            \item (детерминированный) алгоритм зашифрования $\enc$: на вход принимает ключ $K$, параметр-настройку $t \in \Twk$ и сообщение $m \in \Dom$ и возвращает шифртекст $ct \in \Dom$:
            \[
                \enc : \Keys \times \Twk \times \Dom \to \Dom.
            \]
            \item (детерминированный) алгоритм расшифрования $\dec$: на вход принимает ключ $K$, параметр-настройку $t \in \Twk$ и шифртекст $ct \in \Dom$ и возвращает открытый текст-сообщение $m \in \Dom$:
            \[
                \dec : \Keys \times \Twk \times \Dom \to \Dom.
            \]
        \end{itemize}
        Для указанной тройки алгоритмов должно выполняться требование корректности расшифрования: для любого $K \sample \gen$ и любых $t \in \Twk$, $m \in \Dom$ выполнено равенство
        \[
            \dec_K^t(\enc_K^t(m)) = m.
        \] 
    \end{definition}
        
    \begin{remark}
        Введение дополнительного параметра $t \in \Twk$ обусловлено тем, что область определения $\Dom$ может быть слишком маленькой, что приведет к возможности атаки по словарю.
    \end{remark}

    \begin{remark}
        Множество $\Dom$ может быть устроено нестандартно. 
        К примеру, если необходимо шифровать номера банковских карточек, то на множество $\Dom$ налагаются следующие ограничения:
        \begin{itemize}
            \item формат номера~---~16 десятичных цифр.
            \item первые 6 цифр кодируют ID банка, выдавшего карточку (для многих приложений они должны храниться в открытом виде).
            \item последняя цифра является контрольной суммой (хранится в открытом виде)
        \end{itemize} 
        Таким образом, для зашифрования остаются 9 средних цифр в номере карточки, и в этом примере множество $\Dom$ задается как $ \Dom = \{0, \ldots 9 \}^{9} \approx 2^{30}$. 
    \end{remark}

    <<Обычный>> блочный шифр действует на множестве двоичных строк фиксированной длины (например, $\Dom = \{0, 1\}^{128}$ для алгоритма <<Кузнечик>>, см.~\cite{kuzn}), и результат шифрования элемента $m \in \Dom$ может оказаться вне требуемого множества: $\enc_K^t(m) \not\in \Dom$.
    В связи с этим актуальна задача разработки алгоритма, который по ключу $K$ и параметру $t$ порождал бы некоторую подстановку $\enc_K^t \in \SSS_{\Dom}$ со следующими желательными свойствами:
    \begin{itemize}
        \item операции $\enc_K^t$, $\dec_K^{t}$ быстро вычислимы;
        \item при случайном выборе ключа $k \sample \gen$ получаемое отображение $\enc_K^t(\cdot)$ вычислительно неотличимо от случайной подстановки $\pi \sample \SSS_{\Dom}$; 
        \item вероятность успешной атаки схемы мала даже для малых ($\lvert \Dom \rvert \approx 2^{20}$ и менее) областей определения.
    \end{itemize}

\subsection{Подход на основе квазигрупп}
    В работах~\cite{ctcrypt21, fpe22} был предложен подход на основе квазигрупповых операций сдвига.
    В качестве базовой сложной задачи предлагается рассматривать задачу различения случайной подстановки от структурированной: пусть дана некоторая квазигруппа $Q$, мы хотим измерить, насколько композиция квазигрупповых операций (например, серия умножений слева на случайные элементы квазигруппы) похоже на случайную перестановку на множестве $Q$.
    Постановка задачи в несколько неформальном описании может быть представлена следующим образом (больше о теоретико-сложностных сведениях и <<доказуемой стойкости>> криптографических примитивов и протоколов можно посмотреть, например, в~\cite{katz2020introduction}).
    \begin{enumerate}
        \item Противник $\mathcal{A}$ (некоторый вероятностный алгоритм) взаимодействует с оракулом $\mathcal{O}$.
        Перед началом взаимодействия оракул <<подбрасывает монетку>> (выбирает случайный равновероятный бит $b \in \{0, 1\}$).
        \begin{itemize}
            \item Если бит $b = 0$, оракул выбирает случайную подстановку $\pi \in \SSS_Q$ на множестве $Q$ и реализует функцию $f$ как $f(x) = \pi(x)$.
            \item Если бит $b = 1$, оракул выбирает $\lambda$ случайных элементов $q_i \sample Q$, $i = 1, \ldots, \lambda$ и реализует функцию $f$ как
            \[
                f(x) = L_{q_1} \left( L_{q_2} \left( \ldots L_{q_{\lambda}}(x) \ldots \right) \right).
            \]
        \end{itemize}
        \item На запрос противника $x$ оракул $\mathcal{O}$ отвечает $f(x)$.
        \item Изучая ответы оракула, противник должен понять, какой бит выбрал противник до начала взаимодействия. 
        Вероятность противника оценивается как функция от параметров <<количество запросов к оракулу>> и <<количество тактов вычислений противника>>.
    \end{enumerate}
    Если противник может угадать бит $b$ с высокой вероятностью, то он способен отличать истинно случайную подстановку $\pi \in \SSS_Q$ от структурированной 
    \[
        f(x) = L_{q_1} \left( L_{q_2} \left( \ldots L_{q_{\lambda}}(x) \ldots \right) \right).
    \]

    Успех противника зависит от структуры используемой квазигруппы. 
    Так, если, например, задать квазигруппу $(Q, \circ) = (\ZZ_{2^n}, +)$, то полученная структурированная подстановка будет тривиально отличима от случайной, поскольку в таком случае <<левым умножением>> является сложение поданного на вход элемента со случайными элементами $L_q(x) = q + x$, и полученное преобразование будет линейным:
    \[
        f(x + y) - f(x) = y,
    \]
    что позволит легко отличить его от случайной подстановки.

    Свидетельством в пользу того, что рассматриваемая задача может быть сложной, является $\mathsf{NP}$-полнота задачи разрешимости уравнения над полиномиально полной квазигруппой.
    Тем не менее, такое наблюдение может давать теоретические гарантии лишь в <<худшем>> случае, ничего не говоря о <<генерической>> сложности задачи~\cite{kapovich2003generic}.
    Отметим также, что $L$-преобразования (и им родственные) рассматривались, в частности, в работах~\cite{QSP4, artamonov18, yash22}.
    Так, в работе~\cite{yash22} среди прочего показано, что для любой квазигрупповой операции $\circ$ при случайном независимом выборе элементов $k_i \in \Dom$ (при условии, что носитель распределения $k_i$ достаточно большой) распределение элемента $ct$ экспоненциально быстро сходится к равновероятному распределению на множестве $\Dom$.
    При этом результаты работы~\cite{yash22}, вообще говоря, не применимы к ситуации, в которых противник может получать образы различных адаптивно выбираемых $m$.

    Для того, чтобы получить $\fpe$-схему на основе описанной выше задачи необходимо задать пару алгоритмов $\enc$, $\dec$~--- отображений из $\Keys \times \Twk \times \Dom$ в $\Dom$.
    В работе~\cite{fpe22} был предложен следующий подход.
    Будем получать зашифрование элемента $m$ на ключе $K$ и параметре $t$ следующим образом.
    \begin{enumerate}
        \item На первом шаге по ключу $K \in \Keys$ и параметру $t \in \Twk$ построим с помощью псевдослучайной функции (см., например, функцию $\mathsf{PRF}$ из работы~\cite{alekseev16}) последовательность псевдослучайных элементов $q_1, \ldots, q_{\lambda} \in Q$.
        \item На втором шаге переведем с помощью левых квазигрупповых сдвигов заданное сообщение $m \in \Dom$ в сообщение
        \[
            ct = L_{q_1} \left( L_{q_2} \left( \ldots L_{q_{\lambda}}(m) \ldots \right) \right)
        \]
    \end{enumerate}
    Для расшифрования сообщения $ct$ достаточно также провести первый шаг, получив элементы $q_1, \ldots, q_{\lambda} \in Q$, а затем последовательно решить уравнения вида $q_i \circ x = y_i$ ($\lambda$ штук) и получить решение $m$.

    Сложность нахождения решения $m$ по заданным $(t, ct)$ и неизвестном $K$ в предложенной схеме обуславливается двумя факторами:
    \begin{enumerate}
        \item по известному $t$ и неизвестному $K$ трудно восстановить элементы $q_1, \ldots, q_{\lambda} \in Q$, полученные с помощью псевдослучайной функции (и даже отличить их от истинно случайных).
        \item При неизвестных $q_1, \ldots, q_{\lambda}$ трудно отличить результат применения структурированной перестановки 
        \[
            x \to L_{q_1} \circ (L_{q_2} \circ \ldots \circ (L_{q_{\lambda}} \circ x) \ldots )
        \]
        от результата применения случайной перестановки
        \[
            x \to \pi(x).
        \]
    \end{enumerate}

    Рассмотрим ограниченный класс квазигрупп, порожденных правильными семействами функций.
    Пусть $\ff$, $\gf$~--- два правильных семейства размера $n$ на прямом произведении $H^n$ групп $(H, +)$ (не обязательно абелевых).
    Как было отмечено выше (см. утверждение~\ref{propos:bijection}), операция $\sigma_{\ff}(\xx) = \xx \cdot \ff(\xx)$ является подстановкой на множестве $H^n$.
    В таком случае можно рассмотреть следующую операцию умножения $\circ$ на $H^n \times H^n$:
    \begin{equation}
        \label{eq:circ}
        (\xx, \yy) \to \xx \circ \yy = \sigma_{\ff}(\xx) + \sigma_{\gf}(\yy),
    \end{equation}
    где сложение $+$ понимается как покомпонентное сложение в группе $H$.

    Определенное таким образом умножение в $H^n$ может быть эффективно обращено используя следующее соображение.
    Рассмотрим подстановку $\sigma^{-1}_{\ff}$. 
    Как было отмечено в разделе~\ref{sec:properinverse}, подстановка $\sigma^{-1}_{\ff}$ также порождается некоторым правильным семейством $\widetilde{\ff}$ (которое было названо дуальным).
    Семейства $\ff$ и $\widetilde{\ff}$ связаны соотношением:
    \begin{equation}
        \label{eq:dual}
        \widetilde{\ff}(\xx) = (-\xx) + \sigma^{-1}_{\ff}(\xx), \quad \sigma_{\ff}(\xx) = \xx + \ff(\xx), \quad x \in H^n.
    \end{equation}

    Таким образом, если $\ff$ и $\widetilde{\ff}$~--- пара правильных семейств, связанных соотношением~(\ref{eq:dual}), и операция $\circ$ задается формулой~(\ref{eq:circ}), то операция $x \circ y$ обращается справа следующим образом:
    \[
        \xx = \sigma_{\widetilde{\ff}} \left( (\xx \circ \yy) - \sigma_{\gf}(\yy) \right).
    \]
    Аналогичным образом операция $\xx \circ \yy$ может быть обращена слева, используя <<дуальное>> к $\gf$ семейство $\widetilde{\gf}$.

    Из этих соображений вытекает, что как $L$-преобразование, так и обратное к нему $L^{-1}$ могут быть заданы с помощью правильных семейств дискретных функций, что позволяет перейти от табличного задания квазигруппы к функциональному.



\section{Алгоритм проверки правильности булевых семейств}
\label{sec:fastproper}

    В настоящем разделе мы рассмотрим один алгоритм проверки правильности булева семейства $\ff_n$, время работы которого существенно лучше \textquote{наивного} алгоритма.

\subsection{О сложности проверки правильности}
    Полученное в разделе~\ref{sec:uso} взаимно-однозначное соответствие между правильными семействами булевых функций и     $\uso$-ориентациями позволяет перенести часть результатов из теории, развитой в работах~\cite{USOphd,USOcomplexity,numberUSO}, на правильные семейства. 
    В частности, верны следующие утверждения.

    \TODO{верна ли теорема в такой формулировке? Или требование на размер схемы избыточно?}
    \begin{corollary}[{\cite{USOcomplexity}[теорема~5]}]
    \label{coroll:conp}
        Пусть семейство булевых функций задано в виде схемы из функциональных элементов полиномиального от параметра $n$ (размера семейства) размера.
        Тогда задача распознавания правильности семейства по его схеме из функциональных элементов является $\mathsf{coNP}$-полной.
    \end{corollary}

    Заметим, что указанное выше утверждение для случая задания функций в виде КНФ было известно и ранее (см. работу~\cite{nosov98}).
    При этом в определенных случаях задача проверки правильности может быть упрощена, в частности, за счет вида графа существенной зависимости~\cite{rykov10, rykov14}.

    Таким образом, нахождение быстрого (полиномиального по размеру семейства $n$) алгоритма проверки правильности семейства представляется маловероятным.
    Заметим, что \textquote{наивный} алгоритм проверки правильности требует $4^n$ операций вычисления значения семейства $\ff_n$ на наборе $\xx \in \EE_2^n$.

\subsection{Описание алгоритма}
    Рассмотрим алгоритм проверки правильности со сложностью $2 \cdot 3^n$ операций вычисления семейства $\ff_n$ на наборе $x$, который является следствием теоремы~\ref{thm:self_proper}.
    На вход алгоритму подаётся семейство булевых функций $\ff_n$ (например, в виде схем из функциональных элементов в некотором базисе).
    Алгоритм перебирает все проекции исходного семейства $\ff_n$, проверяя выполнение свойства несамодвойственности на какой-либо единственной паре антиподальных наборов из области определения проекции.

    Если существует такая проекция, для которой свойство самодвойственности выполнено, то алгоритм останавливает работу и выдаёт результат <<семейство $\ff_n$ не является правильным>>, поскольку в таком случае по лемме~\ref{lemma:dual} найдётся самодвойственная проекция $\ff_n$, а значит, $\ff_n$ не является правильным.

    Если семейство $\ff_n$ проходит все проверки, то у нас есть гарантия, что для $\ff_n$ и всех его проекций не выполнено свойство самодвойственности: если бы существовал хотя бы один набор $\alpha$, для которого $\overline{F(\alpha)} = F(\bar{\alpha})$, то по лемме~\ref{lemma:dual} нашлась бы полностью самодвойственная проекция, что было исключено в ходе проверок.

    Таким образом, мы доказали корректность следующего алгоритма.

    \begin{Algo}
        Цикл по всем возможным наборам $\xx \in \EE_3^n$:
        \begin{enumerate}
            \item построить два набора $\yy, \zz \in \EE_2^n$ по правилу:
            \begin{itemize}
                \item если $x_i \in \{0, 1\}$, то положить $y_i \gets x_i$, $z_i \gets x_i$,
                \item в противном случае положить 
                $y_i \gets 0$, $z_i \gets 1$,
            \end{itemize}
            \item если существует номер $j$, что $y_j \ne z_j$, и $f_j(y) \ne f_j(z)$, вернуть ответ: \textquote{$\ff_n$ не является правильным}.
        \end{enumerate}
        Если все проверки пройдены успешно, то вернуть: \textquote{$\ff_n$ является правильным}.
    \end{Algo}

    Рассмотренный алгоритм позволяет снизить количество вычислений значения отображения $\ff_n$ в точке с $4^n$ до $2 \cdot 3^n$.
    Вопрос о возможном обобщении алгоритма со случая $k = 2$ на логики большей значности пока что остаётся открытым.


\section{Алгоритм построения представителей}
\label{sec:representatives}

    Описанное в разделе~\ref{sec:isometry_proper} действие группы $\GGG$ на множестве правильных семейств позволяет говорить об отношении эквивалентности между правильными семействами.
    \begin{definition}
        Два семейства $\ff_n$ и $\gf_n$ на $\EE_k^n$ назовем эквивалентными, если существует пара изометрий 
        \[
            \Phi, \Psi \in Iso(\EE_k^n)
        \]
        таких, что $\gf_n(\xx) = \Phi(\ff_n(\Psi(\xx)))$.
    \end{definition}
    Таким образом можно говорить о классах эквивалентности семейств, а также о системе представителей для всех семейств размера $n$.

\subsection{Вспомогательные утверждения}

    Предварительно докажем несколько дополнительных свойств.

    \begin{lemma}
        Пусть $\ff_n$~--- правильное семейство.
        Тогда найдется такая точка $\xx$, что в локальном графе взаимодействий $G_{\ff}(\xx)$ существует сток.
    \end{lemma}

    \begin{proof}
        \TODO{пока что без доказательства, но это точно верно}

        \TODO{Это только для $\EE_2^n$ или для всех?}
    \end{proof}

    % \begin{proof}
    %     Докажем от противного.
    %     Пусть для каждой точки $x$ граф $Gf(x)$ не содержит стоков. %является ациклическим.
    %     Выберем такую точку $x$, что цикл в графе $Gf(x)$ является кратчайшим среди всех возможных: 
    %     \[
    %         i_1 \to i_2 \to \ldots \to i_k \to i_1.
    %     \]
    %     Рассмотрим ограничение $g$ семейства $f$ на подпространство $L = \langle e_{i_1}, \ldots, e_{i_k} \rangle$.
    %     Относительно $g$ мы можем утверждать, что:
    %     \begin{itemize}
    %         \item $g$~--- правильное семейство размера $k$;
    %         \item для \textbf{каждой} точки $x$ граф $Gg(x)$ является либо циклом длины ровно $k$, либо состоит из $k$ несвязных вершин.
    %     \end{itemize}
    %     Второе утверждение следует из того факта, что $Gg(x)$~--- подграф $Gf(x)$ для каждой точки $x$, а потому не может содержать цикл длины меньшей чем $k$.
    %     При этом $Gg(x)$ также не может содержать и нескольких циклов длины $k$ (в противном случае мы могли бы <<укоротить>> исходный цикл).
    %     Случай несвязных вершин
    %     Другими словами, матрица <<локальной существенной зависимости>> для каждой точки $x$ является перестановочной матрицей (возможно, разной). 
    %     Покажем, что такая ситуация невозможна для правильных семейств.

    %     Рассмотрим точку $x = (0, \ldots, 0)$, пусть значение $f(x) = \alpha$.
    %     Будем покоординатно переходить от точки $x$ к ее антиподу, при этом следя за тем, как меняется значение функции.

    %     Зададим $e_{i_0} = (1, 0, \ldots, 0)$, $i_0 = 1$.
    %     Рассмотрим точку $x \oplus e_{i_0}$.
    %     Поскольку $Gg(x)$~--- цикл, то при переходе к указанной точке \textbf{ровно одна} из координат функции изменится, пусть это будет $i_1$ (в силу того, что $Gg(x)$~--- простой цикл).
    %     Заметим, что $i_1 \ne i_0$ (или, другими словами, $i_i \not \in \{i_0\}$), поскольку иначе $g_{i_0}$ существенно зависит от $x_{i_0}$.
    %     В указанной точке значение функции будет равно 
    %     \[
    %         g(x \oplus e_{i_0}) = \alpha \oplus e_{i_1}.
    %     \]
    %     Далее перейдем от $x \oplus e_{i_0}$ к точке $x \oplus e_{i_0} \oplus e_{i_1}$.
    %     При этом поменяется функция с индексом $i_2$.

    %     Будем продолжать указанный процесс.
    %     На каждом шаге будет меняться ровно одна координата функции.
    %     Покажем, что на каждом шаге мы будем получать координату, которая не встречалась ранее, т.е. на $j$-м шаге имеем 
    %     \[
    %         i_{j+1} \not \in \{i_0, \ldots, i_j \}.
    %     \]
    %     Предположим противное: $i_{j+1} = i_k$.
    %     Тогда рассмотрим следующие точки:
    %     \[
    %         u = x \oplus e_{i_0} \oplus \ldots \oplus e_{i_{k-1}},
    %     \]
    %     \[
    %         v = x \oplus e_{i_0} \oplus \ldots \oplus e_{i_{j}} = u \oplus e_{i_k} \oplus \ldots \oplus e_{i_{j}}.
    %     \]
    %     Пусть
    %     \[
    %         g(u) = \beta = \alpha \oplus e_{i_1} \oplus \ldots \oplus e_{i_{k}},
    %     \]
    %     тогда по определению координат $i$ имеем 
    %     \begin{equation*}
    %         g(v) = \beta \oplus e_{i_{k+1}} \oplus \ldots \oplus e_{i_j} \oplus e_{i_{j+1}} = \\
    %         = \beta \oplus e_{i_{k}} \oplus \ldots \oplus e_{i_j} \oplus e_{i_{j}}.
    %     \end{equation*}
    %     Тогда точки $u$ и $v$ различаются в координатах $i_k, \ldots, i_j$, и в тех же координатах различны и значения функции $g(u)$ и $g(v)$, что противоречит правильности $g$.

    %     Таким образом, мы имеем следующий результат: на каждом шаге можно менять одну из координат текущей точки, при этом будет меняться координата функции, причем координаты не повторяются.

    %     Следовательно, в конечном счете мы дойдем до антипода $y$ точки $x$, и $g(x)$ будет отличаться от $g(y)$ во всех координатах, что также противоречит правильности.
    %     Мы пришли к противоречию, следовательно, исходная предпосылка была неверна.
    % \end{proof}

    \begin{corollary}
        Если $\ff$~--- правильное семейство, то существует такая точка $\uu$ и такой индекс $j$, что справедливо равенство 
        \[
            \ff(\xx) = \ff(\xx \oplus e_j).
        \]
    \end{corollary}

    \begin{proof}
        Достаточно рассмотреть точку $\xx$, в которой $\ff$ локально постоянно по направлению $e_j$.
    \end{proof}

    \begin{corollary}
        \label{corol:stdform}
        Если $\ff$~--- правильное семейство, то существует эквивалентное правильное семейство $\gf \equiv \ff$ со свойством
        \[
            \gf(0, \ldots, 0, 0) = \gf(0, \ldots, 0, 1) = (0, \ldots, 0, 0)^T.
        \]
    \end{corollary}

    \begin{proof}
        Возьмем точку $\uu$ из предыдущего утверждения.
        Рассмотрим первое эквивалентное семейство $\gf^{1}(\xx) = \ff(\xx \oplus \uu)$ (внутренний сдвиг).
        Затем перейдем ко второму эквивалентному путем перенумерации функций и переменных так, чтобы $j$ перешло в $n$.
        Затем сдвинем всё семейство (внешний сдвиг) так, чтобы оба значения были равны нулю.
    \end{proof}


\subsection{Алгоритм построения представителей}

    Покажем, что \textbf{систему представителей} правильных семейств размера $n+1$ относительно действия \textbf{полной группы} 
    \[
        \underbrace{\ZZ_2^n}_{\text{внутр. сдвиг}} \times \underbrace{\ZZ_2^n}_{\text{внеш. сдвиг}} \times \underbrace{\SSS_n}_{\text{согл. перенум.}}
    \]
    можно построить из \textbf{системы представителей} правильных семейств размера $n$ относительно действия \textbf{неполной группы} 
    \[
        \underbrace{\ZZ_2^n}_{\text{внеш. сдвиг}} \times \underbrace{\SSS_n}_{\text{согл. перенум.}}.
    \]
    Покажем это.
    Сначала мы можем перейти от произвольного семейства $\widetilde{\ff_{n+1}}$ к эквивалентному ему семейству $\ff_{n+1}$ со свойством, указанном в следствии~\ref{corol:stdform} (действие полной группы).
    Рассмотрим разложение семейства $\ff$ размера $n+1$ на два семейства размера $n$:
    \[
        \ff_{n+1}(\xx, x_{n+1}) = 
        \begin{bmatrix}
            x_{n+1} \cdot \ff_n^1(\xx) \oplus \overline{x_{n+1}} \cdot \ff_n^0(\xx) \\
            f(\xx)
        \end{bmatrix} = 
        \begin{bmatrix}
            x_{n+1} \cdot \gf(\xx) \oplus \overline{x_{n+1}} \cdot \hf(\xx) \\
            f(\xx)
        \end{bmatrix},
    \]
    где $\xx = (x_1, \ldots, x_n)$.
    Поскольку $\ff_{n+1}$ выбрано в соответствии со следствием~\ref{corol:stdform}, то для $\gf$ и $\hf$ справедливы равенства:
    \[
        \gf(0, \ldots, 0) = \hf(0, \ldots, 0) = (0, \ldots, 0)^T.
    \]
    Таким образом, $\gf$ и $\hf$~--- \textquote{несдвинутые} правильные семейства размера $n$.
    Для каждого из них существует представитель (относительно действия неполной группы) размера $n$, отличающийся, возможно, применением согласованной перестановки (не может отличаться внешним сдвигом, т.к. представители несдвинутые):
    \[
        \gf(\xx) = \sigma_1(\gf)(\xx), \quad \hf(\xx) = \sigma_2(\hf)(x).
    \]
    Рассмотрим эквивалентное $\ff_{n+1}$ семейство: согласованно перенумеруем первые $n$ функций и координат в соответствии с подстановкой $\sigma^{-1}$.
    Обозначим $\tau = \sigma_1^{-1} \circ \sigma_2$.
    Тогда семейство
    \[
        \begin{bmatrix}
            x_{n+1} \cdot \gf(\xx) \oplus \overline{x_{n+1}} \cdot \tau(\hf)(\xx) \\
            f'(\xx)
        \end{bmatrix}
    \]
    будет эквивалентно семейству $\ff_{n+1}$ (относительно действия полной группы).

    Таким образом, мы смогли из представителей $\gf$ и $\hf$ размера $n$ получить представителя $\ff_{n+1}$ размера $n+1$ для любого семейства размера $n+1$.
    Полученное множество представителей можно расширить (путем применения внешних, внутренних сдвигов и перестановок) до полного набора правильных семейств.
    Заметим, что построенное множество представителей может быть избыточно в том смысле, что некоторые из полученных представителей на самом деле могут оказаться эквивалентными.

    Таким образом, можно предложить следующий алгоритм построения представителей размера $n+1$.
    \begin{Algo}
        Пусть задано система представителей $\mathcal{A}$ размера $n$ относительно действия неполной группы (внешних сдвигов + согласованных перенумераций).
        Для построения системы представителей размера $n+1$ относительно действия группы необходимо выполнить следующие действия:
        \begin{enumerate}
            \item выбрать $\gf, \hf \in \mathcal{A}$;
            \item выбрать $\tau \in \SSS_n$;
            \item построить граф смежности для пары правильных семейств $(\gf(\xx), \tau(\hf)(\xx))$ аналогично тому, как это сделано в алгоритме из работы~\cite{galatenko2022generation};
            \item задать $(n+1)$-ю функцию $f_{n+1}$ на компонентах связности полученного графа всеми возможными способами;
            \item для каждого полученного продолжения $f_{n+1}$ построить представителя (относительно действия полной группы)
            \[
                \begin{bmatrix}
                    x_{n+1} \cdot \gf(\xx) \oplus \overline{x_{n+1}} \cdot \tau(\hf)(\xx) \\
                    f_{n+1}(\xx)
                \end{bmatrix}.
            \]
        \end{enumerate}
    \end{Algo}

    \TODO{Написать о том, насколько сильно ускоряется перебор? Или зачем это всё}



\section{Некоторые результаты численных экспериментов}
\label{sec:experimental}

    В настоящем разделе мы приведем результаты численных экспериментов.


\subsection{Число различных булевых правильных семейств}

    Введем обозначения:
    \begin{itemize}
        \item $\Delta(n)$: количество булевых треугольных семейств размера $n$;
        \item $\Delta^{\loc}(n)$: количество булевых локально-треугольных семейств размера $n$;
        \item $\Delta^{\rec}(n)$: количество булевых рекурсивно-треугольных семейств размера $n$;
        \item $T(n)$: количество булевых правильных семейств размера $n$.
    \end{itemize}

    Соберем известные результаты для числа правильных булевых семейств различных классов и размеров (см. таблицу~\ref{tab:countfamilies}).
    Числа треугольных семейства размера $n=5$ получено в работе~\cite{allen2014counting} (число $CP$-сетей размера $n=5$).
    Число правильных семейств размера $n=5$ получено в работе~\cite{mathew2013enumerating} (для числа классов эквивалентности замощений пространства), а также в работах~\cite{bosshard2017pseudo, USOphd} (для числа одностоковых ориентаций).

    \begin{table}[h]
        \centering
        \captionsetup{justification=centering} % выравнивание подписи по-центру
        \caption{\label{tab:countfamilies} Число треугольных, рекурсивно, локально треугольных и правильных булевых семейств размера $n$}
        \begin{tabular}{|c|c|c|c|c|}
            \toprule
            Размер $n$  & $\Delta(n)$ & $\Delta^{\rec}(n)$ & $\Delta^{\loc}(n)$ & $T(n)$ \\
            \midrule
            $n = 1$ & 2 & 2 & 2 & 2 \\
            \midrule
            $n = 2$ & 12 & 12 & 12 & 12 \\
            \midrule
            $n = 3$ & 488 & 680 & 680 & 744\\
            \midrule
            $n = 4$ & 481776 & 3209712 & 3349488 & 5541744 \\
            \midrule
            $n = 5$ & 157549032992 & ... & ... & 638560878292512 \\
            \bottomrule
        \end{tabular}
    \end{table}

    Приведем также таблицу, в которой собраны полученные результаты по числу классов эквивалентности для булевых правильных семейств размера $n$ (см. таблицу~\ref{tab:countclasses}).
    \TODO{Что такое классы 1, классы 2?}
    \begin{table}[h]
        \centering
        \captionsetup{justification=centering} % выравнивание подписи по-центру
        \caption{\label{tab:countclasses} Число классов эквивалентности правильных булевых семейств размера $n$}
        \begin{tabular}{|c|c|c|}
            \toprule
            Размер $n$ & Классы 1 & Классы 2 \\
            \midrule
            $n = 1$ & 1 & 1 \\
            \midrule
            $n = 2$ & 2 & 2 \\
            \midrule
            $n = 3$ & 19 & 10 \\
            \midrule
            $n = 4$ & 14614 & 1291 \\
            \bottomrule
        \end{tabular}
    \end{table}



\subsection{Индексы ассоциативности для квазигрупп, построенных по правильным булевым семействам малых размеров}

    Приведем результаты численных экспериментов для количества ассоциативных троек (см. раздел~\ref{subsec:assoc_problem}) в квазигруппах, порожденных правильными семействами булевых функций.

    Для $n=2$ имеется $12$ правильных булевых семейств, с помощью которых можно задать $12^2 = 144$ квазигруппы (используя конструкцию, описанную в разделе~\ref{sec:construction}).
    Для $n = 3$ имеется $744$ правильных булевых семейства, с помощью которых можно задать $744^2 = 553536$ квазигрупп.
    Все порождаемые квазигруппы будут попарно различны: если $F \ne G$, то для некоторого $x$ имеем 
    \[
        \pi_{\ff}(\xx) = \xx \oplus \ff(\xx) \ne \xx \oplus \gf(\xx) = \pi_{\gf}(\xx).
    \]
    Результаты численных экспериментов для $n = 2$ приведены в Табл.~\ref{tab:associdx2}, для $n = 3$~--- приведены в Таб.~\ref{tab:associdx3} и на рис.~\ref{fig:histogram}.

    \begin{table}[h]
        \centering
        \captionsetup{justification=centering} % выравнивание подписи по-центру
        \caption{\label{tab:associdx2} Число квазигрупп с заданным $a(Q)$ для квазигрупп, построенных по правильным булевым семействам размера $n=2$}
        \begin{tabular}{|c|c|}
            \toprule
            $a(Q)$ & Кол-во $Q$ \\
            \midrule
            16 & 32 \\
            \midrule
            32 & 96 \\
            \midrule
            64 & 16 \\
            \bottomrule
        \end{tabular}
    \end{table}

    \begin{table}[h]
        \centering
        \captionsetup{justification=centering} % выравнивание подписи по-центру
        \caption{\label{tab:associdx3} Число квазигрупп с заданным  $a(Q)$ для квазигрупп, построенных по правильным булевым семействам размера $n=3$}
        \begin{minipage}[h]{0.49\linewidth}
            \begin{tabular}{|c|c|}
                \toprule
                $a(Q)$ & Кол-во $Q$ \\
                \midrule
                64 & 27648 \\
                80 & 103424 \\
                88 & 18432 \\
                96 & 82944 \\
                104 & 33792 \\
                112 & 21504 \\
                120 & 21504 \\
                128 & 116352 \\
                \bottomrule
            \end{tabular}
        \end{minipage}
        \hfill
        \begin{minipage}[h]{0.49\linewidth}
            \begin{tabular}{|c|c|}
                \toprule
                $a(Q)$ & Кол-во $Q$ \\
                \midrule
                144 & 3072 \\
                160 & 84480 \\
                176 & 6144 \\
                192 & 18432 \\
                208 & 3072 \\
                256 & 10368 \\
                320 & 2304 \\
                512 & 64 \\
                \bottomrule
            \end{tabular}
        \end{minipage}
    \end{table}

    Для $n = 4$ был проведен статистический эксперимент.
    Случайно равновероятно (среди всех возможных пар) выбирались $N = 10^5$ пар правильных семейств, по каждой паре строилась квазигруппа, подсчитывался индекс ассоциативности полученной квазигруппы.
    Была построена ядерная оценка плотности полученной случайной величины, результат приведен на рис.~\ref{fig:density}.

    \begin{figure}[ht] % Рисунок
        \centerfloat{
            \includegraphics[width=1\linewidth]{histogram.png}
            \caption{Распределение числа квазигрупп с заданным $a(Q)$ для $n = 3$}\label{fig:histogram}
        }
    \end{figure}



    \begin{figure}[ht] % Рисунок
        \centerfloat{
            \includegraphics[width=1\linewidth]{density.png}
            \caption{Оценка плотности распределения квазигрупп, построенных по парам правильных булевых семейств, с заданным $a(Q)$ для $n = 4$}\label{fig:density}
        }
    \end{figure}

    Заметим, что при $n = 2$ достигается минимально возможное значение индекса ассоциативности для квазигрупп порядка 4 (а именно 16).
    При~$n \ge 3$ все полученные индексы ассоциативности существенно превышают минимальные теоретически возможные для квазигрупп заданного порядка.
    Отметим также, что во всех исследованных случаях $n = 2, 3, 4$ минимально достижимый индекс ассоциативности у построенных квазигрупп оказался равным квадрату порядка квазигруппы, в связи с чем можно выдвинуть гипотезу, что у квазигрупп, построенным по парам правильных булевых семейств размера $n$ число ассоциативных троек не может быть меньше, чем $2^{2n}$.

    \begin{figure}[ht] % Рисунок
        \centerfloat{
            \includegraphics[width=1\linewidth]{heatmap.png}
            \caption{Тепловая карта для среднего индекса ассоциативности, усреднение берется по представителям классов эквивалентности, $n = 3$}\label{fig:heatmap}
        }
    \end{figure}

    Для $n=3$ также был проведен следующий эксперимент.
    Все $744$ правильных семейства были разбиты на $10$ классов эквивалентности относительно изометрий пространства Хэмминга (см. таблицу~\ref{tab:countclasses}).
    Затем для каждой пары классов эквивалентности $(F, G)$ перебирались все пары представителей $\ff \in F$, $\gf \in G$ и вычислялся индекс ассоциативности квазигруппы, порождаемой парой правильных булевых семейств $(\ff, \gf)$, после чего вычислялся <<средний индекс ассоциативности>> для пары классов эквивалентности $(F, G)$.
    Результаты эксперимента отображены на рис.~\ref{fig:heatmap}.
    Из приведенной тепловой карты видно, что наиболее неассоциативные квазигруппы порождаются при использовании $6$-го класса эквивалентности, представителем которого является, например, семейство 
    \[
        \left( x_2 x_3, \; x_1 \oplus x_1 x_3, \; x_1 \oplus x_2 \oplus x_1 x_2 \right). 
    \]
    Представители указанного класса изучались в разделе~\ref{sec:quadfamily}: было показано, что представители класса имеют полный граф существенной зависимости, а также изучалось свойство сильной квадратичности (см. теорему~\ref{thm:strongquad}).



\section{Построение правильных семейств}

    \TODO{расширить: замощения плоскости -- извлечь алгоритм порождения новых правильных семейств?}


\section*{Выводы}

    В настоящей главе были рассмотрены некоторые вопросы, связанные с вычислительными аспектами (алгоритм проверки правильности булева отображения, алгоритм порождения системы представителей), а также приведены результаты некоторых статистических и численных экспериментов.
    Также был предложен к рассмотрению алгоритм шифрования, сохраняющего формат сообщений.




% \subsection{Число ассоциативных троек для квазигрупп, заданных правильными семействами булевых функций}


% На множестве всех правильных семейств можно задать действие группы
% $\mathbb{Z}_2^n$ (см. теорему~\ref{thm:additivity}):
% \[
%     F \to F \oplus A
% \]

% Такое действие сохраняет число ассоциативных троек, заданных правильным семейством, 
% поэтому задача поиска числа ассоциативных троек для правильных семейств заданного размера сводится 
% к перебору орбит данного действия.

% Для правильных семейств булевых функций путем перебора неэквивалентных правильных семейств 
% были получены точные оценки минимального числа ассоциативных троек 
% для семейств размера ${m = 1, \ldots 4.}$ 
% Для $m = 5$ была получена оценка сверху. 
% Напомним, что для правильного семейства размера $m$ латинский квадрат, полученный с помощью этого семейства, имеет размер $n = 2^m.$

% \begin{table}[H]
%     \caption{Минимальное число ассоциативных троек для квазигрупп, 
%     порожденных правильными семействами булевых функций размера ${m \le 5}$}
%     \label{tab2}
%     \begin{center}
%     \begin{tabular}{c|c}
%         $n = 2^m$ & $a^*(n)$ \\ 
%         \hline
%         2 & 8 \\
%         4 & 32  \\
%         8 & 88 \\
%         16 & 256 \\
%         32 & $\le 1120$\\
%     \end{tabular}
%     \end{center}
% \end{table}

% Было получено количество правильных семейств, на которых достигается минимальное число ассоциативных троек. 
% При $m = 2$ минимальное число ассоциативных троек достигается на одной орбите (8 правильных семейств), представитель 
% \[
% \begin{bmatrix}
%     f_1(x_1, x_2) \\ 
%     f_2(x_1, x_2) 
% \end{bmatrix} = 
% \begin{bmatrix}
%     0 \\ 
%     x_1 
% \end{bmatrix}.
% \]

% При $m = 3$ минимальное число 
% ассоциативных троек достигается на 
% двух орбитах (64 правильных семейства), представители: 
% \[
%     \begin{bmatrix}
%         f_1(x_1, x_2, x_3) \\ 
%         f_2(x_1, x_2, x_3) \\ 
%         f_3(x_1, x_2, x_3) 
%     \end{bmatrix} = 
%     \begin{bmatrix} 
%         x_2x_3 \\ 
%         x_1 \oplus x_1x_3 \\ 
%         x_1 \oplus x_2 \oplus x_1x_2 
%     \end{bmatrix}
% \]

% \[
%     \begin{bmatrix}
%         f_1(x_1, x_2, x_3) \\ 
%         f_2(x_1, x_2, x_3) \\ 
%         f_3(x_1, x_2, x_3) 
%     \end{bmatrix} = 
%     \begin{bmatrix} 
%         x_2 \oplus x_2x_3 \\ 
%         x_3 \oplus x_1x_3 \\ 
%         x_1 \oplus x_1x_2 
%     \end{bmatrix}
% \]

% При $m = 4$ минимальное число ассоциативных троек 
% достигается на 56 орбитах (21504 правильных семейств).


% Количество ассоциативных троек в латинском квадрате,
% построенном по правильному семейству,
% сильно зависит от вида параметрических функций $\pi_i$ 
% в определении правильного семейства. 
% В частности, если положить все 
% $\pi_i(x_i, y_i) = a_i, a_i \in \mathbb{Z}_2, $
% то построенный латинский квадрат будет задавать 
% полностью ассоциативную структуру,
% и число ассоциативных троек, соответственно, 
% будет равно $(2^m)^3,$
% где $m$ --- размер правильного семейства.

% Для криптографических приложений желательно, 
% чтобы число параметрических подстановок 
% $\pi_i, \; i = 1, \ldots, n,$
% для которых число ассоциативных троек минимально, 
% было как можно больше.
% С этой целью было проанализировано количество 
% параметрических подстановок,
% на которых достигается минимальное число ассоциативных троек. 
% Для $m = 3$ для каждой функции из двух орбит 
% существует 36 параметрических подстановок,
% на которых достигается нижняя оценка числа ассоциативных троек. 
% Данные параметрические подстановки могут быть различны 
% для функций из одной и той же орбиты.

% Для $m = 4$ для 16 орбит (из 56) существует 
% только 2 параметрические подстановки,
% на которых достигается нижняя оценка числа ассоциативных троек,
% для 32 орбит существует 4 таких подстановки, 
% для 8 орбит существует 8 подстановок.  

% Дополнительно можно отметить,
% что минимальное число ассоциативных троек 
% для заданного семейства при $m = 2, 3, 4$ всегда чётно.