\chapter{Свойства правильных семейств}
\label{sec:properties}

    В настоящей главе мы рассмотрим некоторые свойства правильных семейств.
    \begin{enumerate}
        \item В разделе~\ref{sec:proper_automorph} мы рассмотрим задачу поиска стабилизатора множества правильных семейств относительно действий биекциями 
        \[
            (\Phi, \Psi) \curvearrowright \ff \colon x \to \Phi(\ff(\Psi(x)));
        \]
        \item В разделе~\ref{sec:image_preimage} рассмотрены вопросы оценки мощности образов и прообразов при действии отображения
        \[
            \xx \to \ff(\xx), \xx \in \EE_2^n, \ff \text{~--- правильное};
        \]
        \item Раздел~\ref{sec:algprop} посвящен изучению свойств подстановок $\pi_{\ff}$, порождаемых правильными семействами.
    \end{enumerate}

    Результаты главы ранее были опубликованы в~\cite{pdm20, intsys20, dm21, galatenko23}.



\section{Группа преобразований, сохраняющих правильность}
\label{sec:proper_automorph}
    В разделе~\ref{sec:proper_properties} было показано, что сдвиги (внутренние и внешние), а также согласованные перестановки семейства сохраняют свойство семейства \textquote{быть правильным}.
    В настоящем разделе мы рассмотрим обратную задачу.

    Пусть $\Phi$, $\Psi$~--- биекции на множестве $\EE_k^n$: $\Phi, \Psi \in \SSS_{\EE_k^n}$.
    При каких условиях на $\Phi$, $\Psi$ отображение 
    \[
        \xx \to \Phi(\ff(\Psi(\xx)))
    \]
    также будет являться правильным для правильных семейств $\ff$?
    Другими словами, рассматривается вопрос о поиске стабилизатора для множества всех правильных семейств $\ff_n$ размера $n$ при действии группы $\SSS_{E_k^n} \times \SSS_{E_k^n}$ на множестве всех семейств размера~$n$, при котором $(\Phi, \Psi)$ переводит семейство $\ff$ в семейство $\ff'$, заданное соотношением
    \[
        \ff' \colon \xx \to \Phi(\ff(\Psi(\xx))).
    \]
    Далее мы покажем, что такими $\Phi$ и $\Psi$ могут быть только композиции согласованных перестановок и перекодировок семейства (см. определения~\ref{def:sigma} и~\ref{def:reencoding}). 

\subsection{Перекодировки и изометрии пространства $\EE_k^n$}
\label{sec:reencoding}

    Дадим несколько предварительных определений.
    \begin{definition}
    \label{def:vec_reencoding}
        Перекодировкой вектора $\xx \in Q^n$ будем называть вектор $\yy$ вида $\yy =  (\phi_1(x_1), \ldots, \phi_n(x_n))$, где $\phi_i \in \SSS_Q$.
    \end{definition}

    \begin{definition}
    \label{def:reencoding}
        Перекодировкой семейства $\ff_n$, заданного на $Q^n$, будем называть семейство $\gf$ вида:
        \[
            \gf(\xx) = 
            \begin{bmatrix}
                \phi_1(f_1(\psi_1(x_1), \ldots, \psi_n(x_n))) \\
                \vdots \\
                \phi_n(f_n(\psi_1(x_1), \ldots, \psi_n(x_n)))
            \end{bmatrix},
        \]
        где $\phi_i, \psi_i \in \SSS_Q$.
    \end{definition}

    \begin{remark}
        Перекодировка семейства является композицией перекодировки аргумента функции (как вектора) и перекодировки полученного вектора значения функции.
    \end{remark}

    Как было отмечено ранее (см. утверждение~\ref{thm:sigma}), согласованные перестановки сохраняют свойство правильности.
    Аналогичное свойство выполняется и для перекодировок.

    \begin{proposition}[{\cite[Лемма~2]{galatenko21criterion}}]
        Если $\ff_n$~--- правильное семейство, то любая перекодировка $\gf_n$ семейства $\ff_n$ также является правильным семейством.
    \end{proposition}

    Там же доказан следующий критерий правильности семейства в терминах перекодировок, являющийся обобщением критерия из раздела~\ref{sec:boolean_fixpt}.

    \begin{proposition}[{\cite[Теорема~1]{galatenko21criterion}}]
    \label{thm:reencoding_properness}
        Семейство $\ff_n$ на $Q^n$ является правильным тогда и только тогда, когда любая перекодировка любой проекции $\ff_n$ (в том числе и тривиальная проекция) имеет единственную неподвижную точку.
    \end{proposition}

    Заметим, что перекодировки и перестановки вектора (см. определение~\ref{def:sigma_vec}) сохраняют (не)равенство координат вектора.
    Другими словами, если $d(\xx, \yy)$~--- метрика Хэмминга на пространстве $\EE_k^n$, то для перекодировок и перестановок вектора $\Phi$ выполняется равенство 
    \[
        d(\xx, \yy) = d(\Phi(\xx), \Phi(\yy)).
    \]
    Это наблюдение побуждает поставить следующий вопрос: верно ли, что преобразования, сохраняющие правильность, обязаны быть изометриями пространства $\EE_k^n$ с метрикой Хэмминга?
    Далее мы утвердительно ответим на этот вопрос.
    Введем несколько предварительных определений.

    \begin{definition}
        Пусть $(M, d)$~--- метрическое пространство с метрикой $d$, тогда группой изометрий $Iso(M)$ пространства $M$ будем называть множество отображений 
        \[
            Iso(M) = \left\{ \Phi \in \SSS_{M} \mid d(\Phi(\xx), \Phi(\yy)) = d(\xx, \yy) \; \forall \xx, \yy \in M \right\}
        \]
        с операцией композиции отображений.
    \end{definition}

    Нам также понадобится понятие слабой изометрии как отображения, которое сохраняет расстояние между точками, находящимися на строго определенном фиксированном расстоянии.

    \begin{definition}
        Будем называть $p$-изометрией (слабой изометрией) биективное отображение $\Phi \colon M \to M$ такое, что оно сохраняет расстояние между точками, которые находятся на расстоянии~$p$.
        Введем в рассмотрение множество всех $p$-изометрий:
        \[
            Iso_p(M) = \left\{ \Phi \in \SSS_{M} \mid d(\Phi(\xx), \Phi(\yy)) = d(\xx, \yy) \; \forall \xx, \yy \in M, \; d(\xx, \yy) = p \right\}.
        \]
    \end{definition}

    \begin{remark}
    \label{rem:isop_group}
        Легко увидеть, что множество $p$-изометрии $Iso_p(M)$ образует группу относительно операции композиции отображений (в частности, обратное к $p$-изометрии преобразование также является \mbox{$p$-изометрией}).
    \end{remark}

    Приведем два результата, связывающих множество слабых изометрий и изометрий пространств с метрикой Хэмминга~$d$.

    \begin{proposition}[{\cite[Теорема~1]{krasin06}, \cite[Лемма~1]{de2016weak}}]
    \label{propos:bool_iso}
        Если $\Phi$ является 1-изометрией $(\EE_2^n, d)$, то $\Phi$ является изометрией $(\EE_2^n, d)$.
    \end{proposition}

    \begin{proposition}[{\cite[Теорема~4.1]{bruner2014weak}}]
    \label{propos:k_iso}
        Если $\Phi$ является 1-изометрией $(\EE_k^n, d)$, $k > 2$, $n > 2$, то $\Phi$ является изометрией $(\EE_k^n, d)$.
    \end{proposition}

    \begin{remark}
        Из формулировки утверждений~\ref{propos:bool_iso} и~\ref{propos:k_iso} видно, что существуют особые случаи, не покрываемые приведенными выше утверждениями.
        Рассмотрим каждый из них более подробно.
        
        Случай $k > 2$, $n = 1$ тривиален: любая биекция в указанном вырожденном случае является изометрией.
        
        Случай $k > 2$, $n = 2$: пусть $\Phi$ является 1-изометрией и биекцией.
        Покажем, что $\Phi$ также сохраняет расстояние 2.
        Пусть $\alpha, \beta \in \EE_k^2$, $d(\alpha, \beta) = 2$.
        В силу биективности $d(\Phi(\alpha), \Phi(\beta)) > 0$.
        Предположим, что $d(\Phi(\alpha), \Phi(\beta)) = 1$.
        В таком случае, поскольку $\Phi^{-1}$ также является 1-изометрией (см. замечание~\ref{rem:isop_group}), мы имеем противоречие:
        \[
            1 = d\left(\Phi(\alpha), \Phi(\beta) \right) = d \left(\Phi^{-1}(\Phi(\alpha)), \Phi^{-1}(\Phi(\beta)) \right) = d \left( \alpha, \beta \right) = 2.
        \]
        Других значений расстояния в случае $n = 2$ не бывает.
    \end{remark}

    Таким образом, мы доказали следующее вспомогательное утверждение.
    \begin{lemma}[{\cite[лемма~7]{fpm23}}]
    \label{lemma:main_iso}
        Группа 1-изометрий пространства $\EE_k^n$ с метрикой Хэмминга совпадает с группой всех изометрий пространства $\EE_k^n$:
        \[
            Iso_1(\EE_k^n) = Iso(\EE_k^n).
        \]
    \end{lemma}

    Также для пространств Хэмминга верно следующее утверждение, устанавливающее связь между изометриями $\EE_k^n$ и ранее введенными преобразованиями векторов (см. определения~\ref{def:vec_reencoding} и~\ref{def:sigma_vec}).

    \begin{proposition}[{\cite{chirivi}}]
    \label{propos:iso}
        Группа изометрий $Iso(\EE_k^n)$ состоит из композиций перестановок и перекодировок векторов.
    \end{proposition}


\subsection{Группа биективных преобразований, сохраняющих правильность}
\label{sec:isometry_proper}

    Нашей задачей является доказательство того факта, что если $\Phi$ и $\Psi$~--- биекции, и $\Phi(\ff_n(\psi(x)))$~--- правильное семейство для любого правильного семейства $\ff_n \colon \EE_k^n \to \EE_k^n$, то $\Phi$, $\Psi$ являются изометриями пространства $Iso(\EE_k^n)$.
    Для этого мы сначала докажем, что $\Phi$ и $\Psi$ должны быть $1$-изометриями (леммы~\ref{lemma:inner_iso} и~\ref{lemma:outer_iso}).
    Тогда из леммы~\ref{lemma:main_iso} будет следовать, что $\Phi$ и $\Psi$ являются изометриями $\EE_k^n$.
    Наконец, мы применим утверждение~\ref{propos:iso} совместно с некоторыми дополнительными соображениями и покажем, что биективные преобразования, сохраняющие правильность семейств, исчерпываются перекодировками и согласованными перестановками семейства (теорема~\ref{thm:propergroup}).

    \begin{remark}
        Мы рассматриваем только пары биективных преобразований.
        Так, например, в указанные преобразования не входят преобразования вида $f_n(x_1, \ldots, x_n) \to a$, $a \in \EE_k$, $f_i(x_1, \ldots, x_n) \to f_i(x_1, \ldots, x_{n-1}, a)$, $1 \le i \le n-1$ (комбинация проекции семейства с дополнением константой), которые сохраняют правильность, а также преобразования, описанные в работе~\cite{galatenko2022generation}.
    \end{remark}

    Как уже было отмечено ранее (см. замечание~\ref{rem:antipode}), правильное семейство не может принимать противоположные значения.
    Однако верно следующее утверждение.
    \begin{lemma}
    \label{lemma:notmirror}
        Пусть $\alpha$, $\beta \in Q^n$~--- два не-противоположных набора (т.е. $d(\alpha, \beta) < n$).
        Тогда существует правильное семейство $\ff_n$ и точки $\xx$, $\yy$, такие что $\ff(\xx) = \alpha$, $\ff(\yy) = \beta$.
    \end{lemma}

    \begin{proof}
        Достаточно рассмотреть правильным образом подобранное треугольное семейство.
        Без ограничения общности будем предполагать, что первые $\ell$ координат наборов совпадают:
        \[
            \alpha_1 = \beta_1, \ldots, \alpha_{\ell} = \beta_{\ell}, \ell \ge 1.
        \]
        В таком случае зададим первые $\ell$ функций треугольного семейства как константы 
        \[
            f_i \equiv \alpha_i, \; 1 \le i \le \ell,
        \]
        оставшиеся $(n-\ell)$ функций зададим так, чтобы на некотором фиксированном $\xx_0$ они принимали значение $\alpha_{\ell+1}, \ldots, \alpha_n$, на некотором фиксированном $\yy_0$ (отличном от $\xx_0$ в первых $\ell$ координатах)~--- значение $\beta_{\ell+1}, \ldots, \beta_n$.
        Тогда мы получим семейство вида 
        \[
            \begin{bmatrix}
                \alpha_1 \\
                \vdots \\
                \alpha_{\ell} \\
                \ff_{n-\ell}(x_1, \ldots, x_{\ell})
            \end{bmatrix},
        \]
        которое является треугольным и обладает требуемым свойством.
    \end{proof}

    \begin{lemma}
    \label{lemma:inner_iso}
        Пусть семейства $\gf(\xx)$ вида $\gf(\xx) = \Phi(\ff(\Psi(\xx)))$ являются правильным для всех правильных семейств $\ff$, заданных на $\EE_k^n$, $\Phi$ и $\Psi$~--- биекции множества $\EE_k^n$.
        Тогда $\Psi$ является 1-изометрией пространства Хэмминга $\EE_k^n$.
    \end{lemma}

    \begin{proof}
        Докажем от противного.
        Предположим, что $\Psi$ не является 1-изометрией, $\Phi$ и $\Psi$ биективны, и покажем, что существует такое правильное семейство $\ff$ на $\EE_k^n$, что $\gf(\xx) = \Phi(\ff(\Psi(\xx)))$ не является правильным.

        Так как $\Psi$~--- не 1-изометрия, то найдутся наборы $\xx_1$, $\xx_2$, что $d(\xx_1, \xx_2) = 1$, но $d(\Psi(\xx_1), \Psi(\xx_2)) > 1$ (заметим, что указанное расстояние не может быть равно 0, т.к. $\Psi$ биективно).
        Пусть для определенности $\xx_1$ и $\xx_2$ различны только в $i$-й координате, и найдутся такие индексы $j_1, j_2$, что $\Psi(\xx_1)$ и $\Psi(\xx_2)$ различны в позициях $j_1$ и $j_2$.
        Подберем такое семейство $\ff_n$, что выполнено неравенство
        \[
            \gf_i(\xx_1) = \Phi(\ff(\Psi(\xx_1)))[i] \ne \Phi(\ff(\Psi(\xx_2)))[i] = \gf_i(\xx_2).
        \]

        Рассмотрим множество пар точек $(\ww_1, \ww_2)$, $\ww_1, \ww_2 \in \EE_k^n$, таких что $\ww_1[i] \ne \ww_2[i]$.
        Число таких пар точек равно $k^{2n-1}(k-1)$, поскольку есть $k^n$ способов зафиксировать $\ww_1$ и $k^{n-1}(k-1)$ способов зафиксировать $\ww_2$.
        Теперь рассмотрим множество пар точек 
        \[
            (\yy_1, \yy_2) = (\Phi^{-1}(\ww_1), \Phi^{-1}(\ww_2)).
        \]
        Среди таких пар найдется пара со свойством $\yy_1[j_1] = \yy_2[j_1]$ или $\yy_1[j_2] = \yy_2[j_2]$, поскольку число пар, не удовлетворяющих этому свойству, равно $k^{2n-2}(k-1)^2$, что меньше числа $k^{2n-1}(k-1)$.

        Таким образом, найдутся две точки $\yy_1$, $\yy_2$ со свойствами:
        \begin{itemize}
            \item $\Phi(\yy_1)[i] \ne \Phi(\yy_2)[i]$;
            \item $\yy_1[j] = \yy_2[j]$, где $j \in \{j_1, j_2\}$.
        \end{itemize}
        Построим по этим точкам семейство $\ff$ так, чтобы выполнялись равенства 
        \[
            \ff(\Psi(\xx_1)) = \yy_1, \; \ff(\Psi(\xx_2)) = \yy_2.
        \]

        Для этого рассмотрим треугольное семейство $\ff$, такое что $f_j(\cdot) \equiv \yy_1[j]$, а остальные функции зависят от $j$-й переменной таким образом, что если она принимает значение $\Psi(\xx_1)[j]$, то все семейство равно $\yy_1$, а если она принимает значение $\Psi(\xx_2)[j]$, то все семейство равно $\yy_2$.

        Построенное семейство $\ff$ будет правильным (в силу треугольности).
        При этом будет выполняться условие:
        \[
            \Phi(\ff(\Psi(\xx_1)))[i] = \Phi(\yy_1)[i] \ne \Phi(\yy_2)[i] = \Phi(\ff(\Psi(\xx_2)))[i],
        \]
        а значит, семейство $\gf$ не является правильным (нарушено условие правильности на паре наборов $\xx_1$, $\xx_2$).
    \end{proof}

    \begin{remark}
    \label{rem:inner_iso}
        Из доказанного утверждения и леммы~\ref{lemma:main_iso} следует, что $\Psi$ является изометрией пространства $\EE_k^n$ с метрикой Хэмминга.
    \end{remark}

    \begin{lemma}
    \label{lemma:outer_iso}
        Пусть семейства $\gf(\xx)$ вида $\gf(\xx) = \Phi(\ff(\Psi(\xx)))$ являются правильным для всех правильных семейств $\ff$, заданных на $\EE_k^n$, $\Phi$ и $\Psi$~--- биекции множества $\EE_k^n$.
        Тогда $\Phi$ является 1-изометрией пространства Хэмминга $\EE_k^n$.
    \end{lemma}

    \begin{proof}
        Случай биективного отображения $\Psi$, не являющегося изометрией, был разобран ранее, поэтому мы можем предполагать, что $\Psi$~--- изометрия.

        Предположим, что $\Phi$~--- не 1-изометрия.
        Это означает, что найдутся наборы $\yy_1, \yy_2 \in \EE_k^n$ такие, что 
        \[
            d(\yy_1, \yy_2) = 1, d(\Phi(\yy_1), \Phi(\yy_2)) = t > 1;
        \]
        указанное расстояние не может быть равно 0, т.к. $\Phi$~--- биекция.
        Для определенности обозначим через $j$ индекс, в котором $\yy_1$ и $\yy_2$ различаются: $\yy_1[j] \ne \yy_2[j]$.

        Если мы предположим, что $t = n$, то по лемме~\ref{lemma:notmirror} найдется правильное семейство $\ff_n$, которое принимает оба значения $\yy_1$ и $\yy_2$ на некоторых $\xx_1$, $\xx_2$.
        Но тогда $\Phi(\ff_n(\Psi(\xx)))$ не может быть правильным, так как принимает противоположные значения (см. замечание~\ref{rem:antipode}).

        Следовательно, мы имеем $1 < t < n$.
        Будем считать без ограничения общности, что $\Phi(\yy_1)$ и $\Phi(\yy_2)$ различаются в первых $t$ индексах: 
        \[
            \Phi(\yy_1)[i] \ne \Phi(\yy_2)[i], \; 1 \le i \le t.
        \]
        
        Построим два набора $\xx_1, \xx_2 \in \EE_k^n$ и правильное семейство $\ff_n$ так, чтобы выполнялись условия:
        \[
            \ff_n(\Psi(\xx_1)) = \yy_1, \; \ff_n(\Psi(\xx_2)) = \yy_2,
        \]
        при этом потребуем, чтобы 
        \begin{itemize}
            \item $\xx_1[i] \ne \xx_2[i]$ при $1 \le i \le t$,
            \item $\xx_1[i] = \xx_2[i]$ при $t+1 \le i \le n$.
        \end{itemize}
        Поскольку $\Psi$ по предположению является изометрией, то 
        \[
            d(\Psi(\xx_1), \Psi(\xx_2)) = t > 1,
        \]
        следовательно, найдется $j' \ne j$, такой что $\Psi(\xx_1)[j'] \ne \Psi(\xx_2)[j']$.
        Зададим $j$-ю функцию семейства $\ff_n$ следующим образом:
        \begin{itemize}
            \item $\yy_1[j]$, если $j'$-я переменная принимает значения $\Psi(x_1)[j']$,
            \item $\yy_2[j]$, если $j'$-я переменная принимает значения $\Psi(x_2)[j']$.
        \end{itemize}
        Остальные функции $f_i$ положим тождественно равными $\yy_1[i]$, где $1 \le i \le n$, $i \ne j$.
        Полученное семейство является треугольным, а следовательно, правильным.
        Для семейства $\gf(\xx) = \Phi(\ff(\Psi(\xx)))$ условие правильности нарушается на наборах $\xx_1$ и $\xx_2$.
        Мы предположили, что $\Phi$ не является 1-изометрией, и пришли к противоречию, из которого следует утверждение.
    \end{proof}

    \begin{remark}
    \label{rem:outer_iso}
        Из доказанного утверждения и леммы~\ref{lemma:main_iso} следует, что $\Phi$ является изометрией $\EE_k^n$.
    \end{remark}

    \begin{theorem}
    \label{thm:propergroup}
        Пусть семейства $\gf(\xx)$ вида $\gf(\xx) = \Phi(\ff(\Psi(\xx)))$ являются правильным для всех правильных семейств $\ff$, заданных на $\EE_k^n$, $\Phi$ и $\Psi$~--- биекции множества $\EE_k^n$.
        Тогда $\Phi$ и $\Psi$ имеют вид 
        \[
            \Phi = \sigma \circ A, \Psi = \sigma \circ B, 
        \]
        где использованы следующие обозначения:
        \begin{itemize}
            \item $\sigma \in \SSS_n$ (перенумерация координат вектора),
            \item $A, B \in \left( \SSS_{\EE_k} \right)^n$ (перекодировки вектора). 
        \end{itemize}
    \end{theorem}

    \begin{proof}
        Мы уже показали (см. замечания~\ref{rem:inner_iso} и~\ref{rem:outer_iso}), что $\Phi$ и $\Psi$ обязаны быть изометриями пространства~$\EE_k^n$.
        Из леммы~\ref{propos:iso} следует, что $\Phi = (\sigma_1 \circ A)$, $\Psi = (\sigma_2 \circ B)$, где $\sigma_1, \sigma_2 \in \SSS_n$, $A, B \in \left( \SSS_{\EE_k} \right)^n$.
        Покажем, что в таком случае $\sigma_1 = \sigma_2$ (т.е. перенумерация семейства должна быть согласованной).

        Применение покомпонентных преобразований $A$ и $B$ не меняет свойства правильности, поэтому можно ограничиться случаем рассмотрения $\Phi = (\sigma_1 \circ \mathsf{id})$, $\Psi = (\sigma_2 \circ \mathsf{id})$, где $\mathsf{id}$~--- тождественное преобразование $\EE_k^n \to \EE_k^n$.
        Пусть $\sigma_1 \ne \sigma_2$.
        Тогда существуют $i$ и $j$ со свойством $\sigma_1(i) = \sigma_2(j) = s$, при этом $i \ne j$.
        В таком случае достаточно рассмотреть треугольное семейство $f_i(x_j) = x_j$, $f_{\ell} \equiv const$, $\ell \ne i$.
        Под действием $(\Phi, \Psi) \curvearrowright \ff$ семейство $\ff$ перейдет в семейство, включающее в себя функцию $f_{\sigma_1(i)}(x_{\sigma_2(j)}) = f_s(x_s) = x_s$, что противоречит правильности.
    \end{proof}

    \begin{remark}
        Заметим, что в булевом случае $k=2$ перекодировки семейства исчерпываются сдвигами.
        Для одностоковых ориентаций булева куба (см. раздел~\ref{sec:uso}) внешние и внутренние сдвиги, равно как и согласованная перенумерация сохраняют свойство ориентации быть одностоковой (подробнее см.~\cite[Лемма~4.4]{USOphd}).
        Таким образом, в булевом случае имеется взаимно-однозначное соответствие между \textquote{алгебраическим} и \textquote{геометрическим} описанием семейства.
        В случае $k$-значной логики группа преобразований, сохраняющих правильность, является более широкой, чем группа преобразований, сохраняющих \textquote{одностоковость}, и указанное соответствие разрушается.
    \end{remark}

    \TODO{Нужно ли как-то дополнить про $k$-значный случай?}




\section{Образы и пробразы при действии правильного семейства}
\label{sec:image_preimage}

    В этом разделе мы будем рассматривать булево семейство $\ff_n$ как отображение $\EE_2^n \to \EE_2^n$:
    \begin{equation*}
        \xx = \begin{bmatrix}
            x_1 \\
            \vdots \\
            x_n
        \end{bmatrix}
        \to \ff_n(\xx) = 
        \begin{bmatrix}
            f_1(x_1, \ldots, x_n) \\
            \vdots \\
            f_n(x_1, \ldots, x_n)
        \end{bmatrix}.
    \end{equation*}

    Как было показано в работе~\cite{galatenko23}, мощность образа правильного семейства является важной характеристикой, которая, в частности, определяет, какое количество различных $d$-квазигрупп может быть порождено с помощью конструкции, описанной в утверждении~\ref{thm:dquasi_proper}.

    Для правильных семейств выполняется следующее ограничение на мощность образа.
    \begin{proposition}[{\cite[Теорема~5]{galatenko23}}]
    \label{thm:image}
        Число значений, принимаемых правильным семейством порядка~$n$ в $k$-значной логике, не превосходит~$k^{n-1}$.
    \end{proposition}


\subsection{Мощность прообраза при действии правильного семейства}
\label{sec:preimage_boolean}

    Зададимся следующим вопросом. 
    Пусть дана точка $\alpha \in \EE_2^n$.
    Что в таком случае можно сказать о мощности множества прообразов точки $\alpha$ при действии отображения $\ff_n$:
    \[
        \ff_n^{-1}(\alpha) = \{\xx \in \ZZ_2^n \mid \ff_n(\xx) = \alpha \}.
    \]
    Оказывается, что для правильных семейств булевых функций верна следующая теорема.

    \begin{theorem}[{\cite[Теорема~7]{dm21}}]
    \label{thm:preimage}
        Пусть $\ff_n$~--- правильное семейство булевых функций.
        Тогда для любого $\alpha \in \EE_2^n$ число решений уравнения $\ff_n(\xx) = \alpha$ всегда четно.
    \end{theorem}

    \begin{remark}
    \label{rem:eqn}
        Случай уравнения $\ff_n(\xx) = \alpha$ можно свести к рассмотрению уравнения $\ff_n(\xx) =  0^n$.
        По утверждению~\ref{thm:outer_shift} если $\ff_n(\xx)$~--- правильное семейство, то и $\gf(\xx) = \ff(\xx) \oplus \alpha$ также является правильным.
        При этом $\xx^*$ является решением уравнения $\ff(\xx) = \alpha$ тогда и только тогда, когда $\xx^*$ является решением уравнения $\gf(\xx) = 0^n$.
    \end{remark}

    \begin{proof}
        Используя замечание~\ref{rem:eqn}, достаточно доказать, что уравнение $\ff_n(\xx) = 0^n$ всегда имеет четное число решений, где $\ff_n$~---~правильное семейство булевых функций размера $n$.
        Будем вести доказательство индукцией по размеру правильного семейства.

        \textbf{База индукции $(n=1)$:} семейства размера 1~---~это константные функции
        \begin{gather*}
            0(x_1) \equiv 0, \\
            1(x_1) \equiv 1.
        \end{gather*} 
        Очевидно, что для этих двух семейств уравнение $\ff_1(x_1) = 0$ имеет 2 или 0 решений соответственно.

        \textbf{Предположение индукции:} допустим, что уравнение $\gf_k(\xx) = 0^k$ имеет четное число решений для любого правильного семейства $\gf$ размера $k \le n$.
        Пусть теперь нам дано правильное булево семейство $\ff_{n+1}$ размера $n+1$.
        Введем обозначение $\xx = (x_1, \ldots, x_n)$.
        По свойству правильности мы можем утверждать, что $f_{n+1}$ не зависит существенно от переменной $x_{n+1}$ (см. замечание~\ref{rem:essential_general}).
        С учетом этого замечания мы можем считать, что $f_{n+1}$ зависит только от первых $n$ переменных, то есть от $\xx$.
        Тогда верно следующее разложение:
        \[
            \ff_{n+1}(x_1, \ldots, x_{n+1}) = 
            \begin{bmatrix}
                x_{n+1} \cdot \ff^1(\xx) \oplus \overline{x_{n+1}} \cdot \ff^0(\xx) \\
                f_{n+1}(\xx)
            \end{bmatrix},
        \]
        где через $\ff^b(x)$, $b \in \{0, 1\}$, обозначены семейства-проекции
        \[
            \ff^b(\xx) = \proj_{n+1}^b(\ff_{n+1}) = 
            \begin{bmatrix}
                f_1(x_1, \ldots, x_{n}, b) \\
                \vdots \\
                f_{n}(x_1, \ldots, x_{n}, b) \\
            \end{bmatrix}.
        \]

        Заметим, что оба семейства $\ff^b$, $b \in \{0, 1\}$, также являются правильными семействами размера $n$ (согласно утверждению~\ref{thm:proj}), а значит, к ним применимо предположение индукции.

        Рассмотрим множество $M$ решений уравнения $f_{n+1}(\xx) = 0$:
        \[
            M = \{ \xx^* \mid f_{n+1}(\xx^*) = 0 \} \subseteq \EE_2^n.
        \]
        Если $M = \emptyset$, то нет ни одного решения уравнения $\ff_{n+1}(x_1, \ldots, x_{n+1}) = 0^{n+1}$, и утверждение теоремы верно для $\ff_{n+1}$.

        Если набор $\xx^* \in M$ таков, что $\ff^0(\xx^*) = \ff^1(\xx^*) = 0^{n}$, то мы можем продолжить набор $\xx^*$ любым значением $x_{n+1} \in \{0, 1\}$ и получить два набора $(\xx^*, 0)$, $(\xx^*, 1)$, каждый из которых является решением исходного уравнения.

        Если набор $\xx^* \in M$ таков, что $\ff^0(\xx^*) \ne 0^{n}$, $\ff^1(\xx^*) \ne 0^{n}$, то для любого продолжения $x_{n+1}$ получим $\ff_{n+1}(\xx^*, x_{n+1}) \ne 0^{n+1}$, то есть такой набор $\xx^*$ не продолжается до решения исходного уравнения.

        Если набор $\xx^* \in M$ таков, что $\ff^0(\xx^*) \ne 0^{n}$, $\ff^1(\xx^*) = 0^{n}$ (или наоборот, $\ff^0(\xx^*) = 0^{n}$, $\ff^1(\xx^*) \ne 0^{n}$), то продолжение $x_{n+1}$ возможно единственным способом ($x_{n+1} = 1$ в первом случае и $x_{n+1} = 0$ во втором случае). 
        Следовательно, необходимо показать, что может существовать только четное число наборов $\xx^*$ таких, что ровно одно из подсемейств $\ff^0(\xx^*)$ или $\ff^1(\xx^*)$ равно нулю на нем.

        Схематично все наборы из множества $M$ можно разбить на 4 категории (см. таблицу~\ref{table1}): 
        \[
            M = A \sqcup B \sqcup C \sqcup D,
        \]
        где 
        \begin{itemize}
            \item $A$~--- множество наборов $\xx^* \in M$, для которых $\ff^0(\xx^*) = \ff^1(\xx^*) = 0$, 
            \item $B$~--- множество наборов $\xx^* \in M$, для которых $\ff^0(\xx^*) \ne 0, \, \ff^1(\xx^*) = 0$, 
            \item $C$~--- множество наборов $\xx^* \in M$, для которых $\ff^0(\xx^*) = 0, \, \ff^1(\xx^*) \ne 0$, 
            \item $D$~--- множество наборов $\xx^* \in M$, для которых $\ff^0(\xx^*) \ne 0, \, \ff^1(\xx^*) \ne 0$.
        \end{itemize}

        \begin{table}[h]
            \centering
            \captionsetup{justification=centering} % выравнивание подписи по-центру
            \caption{\label{table1} Разбиение множества $M$}
            \begin{tabular}{|c|c|c|}
                \toprule
                & $\ff^0(\xx^*) = 0^{n}$ & $\ff^0(\xx^*) \ne 0^{n}$ \\
                \midrule
                $\ff^1(\xx^*) = 0^{n}$ & $A$ & $B$ \\
                \midrule
                $\ff^1(\xx^*) \ne 0^{n}$ & $C$ & $D$ \\
                \bottomrule
            \end{tabular}
        \end{table}

        Нам достаточно доказать, что $|B| + |C|$ четно.
        По предположению индукции мы знаем, что число решений уравнений $\ff^0(\xx) = 0^{n}$ и $\ff^1(\xx) = 0^{n}$ четно, то есть $|A| + |B|$ и $|A| + |C|$~--- четные числа. 
        Но тогда четно и число $(|A| + |B|) + (|A| + |C|) = 2|A| + (|B| + |C|)$, а следовательно, $|B|+|C|$ также четно.

        Таким образом, мы получили четное число продолжений набора $\xx^* \in M$ до полного решения исходной системы $\ff_{n+1}(x_1, \ldots, x_{n+1}) = 0^{n+1}$, что и требовалось доказать.
    \end{proof}


\subsection{Мощность образов некоторых семейств}
\label{sec:image_size}

    В настоящем разделе изучаются некоторые из приведенных в разделе~\ref{sec:proper_examples} примеров правильных семейств булевых функций с точки зрения мощности образа.

    Рассмотрим семейство~(\ref{example:family1}) из раздела~\ref{sec:quadfamily}.
    Введем несколько дополнительных обозначений:
    \begin{itemize}
        \item обозначение для суммы:
        \[ 
            S = S(x_1, \ldots, x_n) = x_1 \oplus \ldots \oplus x_n.
        \]
        \item обозначение для веса Хэмминга двоичного вектора $\xx$:
        \[
            wt(x) = \big \lvert \{ i \mid x_i = 1 \} \big \rvert.
        \]
        \item обозначение для подстановки $\inv$, которая переставляет в обратном порядке элементы на входе:
        \[
            \inv((x_1, \ldots, x_{\ell})) = (x_{\ell}, \ldots, x_1).
        \]
    \end{itemize}
    
    Покажем, что семейство $\ff_n$ из раздела~\ref{sec:proper_examples} имеет максимально возможную (для правильного булева семейства) мощность образа, а именно, $\lvert \Img(F^m) \rvert = 2^{n-1}$.

    Доказательству предпошлем несколько технических лемм.
    \begin{lemma}[{\cite[Лемма~3]{galatenko23}}]
    \label{lemma:proj}
        Проекция семейства $\ff_n$ на любую из его координат не меняет вида семейства. 
        Более точно, результат операции взятия проекции на уровнях~$0$ и~$1$ устроен следующим образом:
        \begin{gather*}
            \proj^0_{i}(\ff_n) = \ff_{n-1}(x_1, \ldots, x_{i-1}, x_{i+1}, \ldots, x_n), \\
            \proj^1_{i}(\ff_n) = \inv(\ff_{n-1})(x_1, \ldots, x_{i-1}, x_{i+1}, \ldots, x_n) \oplus (\underbrace{0, \ldots, 0}_{i-1}, \underbrace{1, \ldots, 1}_{n-i}).
        \end{gather*}
    \end{lemma}

    \begin{proof}
        Доказательство осуществляется прямой подстановкой $x_i \gets 0$ и $x_i \gets 1$ в каждую из функций семейства $\ff_n$ и последующим сокращением совпадающих членов.
        Так, подстановка $x_i \gets 0$ не меняет вида семейства: все члены вида $x_i x_j$, $j \in \{1, \ldots, n\}$, $j \ne i$, обнуляются, из линейной части убирается член $x_i$.
        При подстановке $x_i \gets 1$ для функций $\ff_n[j]$ с $j > i$ в линейной части добавляется член $\oplus 1$. 
        Кроме того, некоторые квадратичные слагаемые вырождаются в линейные, что приводит к следующему изменению линейной части:
        \[
            x_1 \oplus \ldots \oplus x_{j-1} \to 
        \]
        \[ 
            \to x_1 \oplus \ldots \oplus x_{j-1} \oplus 
            x_1 \oplus \ldots \oplus x_{j-1} \oplus
            x_{j+1} \oplus \ldots \oplus x_{n},
        \]
        что соответствует рассмотрению семейства $\inv(\ff_{n-1}(\inv(\xx)))$.
    \end{proof}


    \begin{lemma}[{\cite[Лемма~4]{galatenko23}}]
        \label{lemma:negation}
        Справедливо равенство
        \begin{multline*}
            \ff_n(x_1, \ldots, x_{i-1}, x_i \oplus 1, x_{i+1}, \ldots, x_n) = \\
            = \ff_n(x_1, \ldots, x_n) \oplus 
            \begin{bmatrix}
                0 \\
                \vdots \\
                0 \\
                0 \\
                1 \\ 
                \vdots \\
                1
            \end{bmatrix}
            \oplus
            \begin{bmatrix}
                S \oplus x_1 \oplus x_i \\
                \vdots \\
                S \oplus x_{i-1} \oplus x_i \\
                0 \\
                S \oplus x_{i+1} \oplus x_i \\
                \vdots \\ 
                S \oplus x_n \oplus x_i
            \end{bmatrix}.
        \end{multline*}
    \end{lemma}

    \begin{proof}
        Доказывается прямой проверкой: при замене $x_i \to x_i \oplus 1$ для $\ff_n[j]$, $j > i$ в линейной части появляется дополнительное слагаемое $\oplus 1$, в квадратичной части каждой функции (кроме $\ff_n[i]$) изменяется произведение вида:
        \[ 
            x_i \cdot (S \oplus x_i \oplus x_j) \to (x_i \oplus 1) \cdot (S \oplus 1 \oplus x_i \oplus 1 \oplus x_j) = 
        \]
        \[
            = x_i \cdot (S \oplus x_i \oplus x_j) \oplus S \oplus x_i \oplus x_j.
        \]
        Функция $\ff_n[i]$ не изменяется, так как $\ff_n[i]$ зависит от $x_i$ фиктивно.
    \end{proof}


    \begin{lemma}[{\cite[Лемма~5]{galatenko23}}]
    \label{lemma:full_negation}
        Справедливо равенство
        \begin{multline*}
            \ff_n(x_1 \oplus 1, \ldots, x_n \oplus 1) = 
            \ff_n(x_1, \ldots, x_n) \oplus\\
            \oplus
            \begin{bmatrix}
                \left (n + \frac{n(n+1)}{2} \right ) \bmod 2\\ 
                \left (n-1 + \frac{n(n+1)}{2} \right ) \bmod 2\\
            \left ( n-2 + \frac{n(n+1)}{2} \right ) \bmod 2 \\
                \vdots \\
                \left (1 + \frac{n(n+1)}{2} \right ) \bmod 2
            \end{bmatrix}
            \oplus 
            (n \bmod 2) \cdot 
            \begin{bmatrix}
                S \oplus x_1 \\
                S \oplus x_2 \\
                S \oplus x_3 \\
                \vdots \\
                S \oplus x_n \\
            \end{bmatrix}.
        \end{multline*}
    \end{lemma}

    \begin{proof}
        Доказываем путем последовательного применения леммы~\ref{lemma:negation}.
        На первом шаге имеем:
        \begin{multline*}
            \ff_n(x_1 \oplus 1, \ldots, x_n \oplus 1)
                = \ff_n(x_1, x_2 \oplus 1, \ldots, x_n \oplus 1) \oplus \\
            \oplus
            \begin{bmatrix}
                0 \\
                S(x_1, x_2 \oplus 1, \ldots, x_n \oplus 1) \oplus x_2 \oplus 1 \\
                S(x_1, x_2 \oplus 1, \ldots, x_n \oplus 1) \oplus x_3 \oplus 1 \\
                \vdots \\
                S(x_1, x_2 \oplus 1, \ldots, x_n \oplus 1) \oplus x_n \oplus 1 \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                x_1 \\
                x_1 \\
                \vdots \\
                x_1 \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                1 \\
                1 \\
                \vdots \\
                1 \\
            \end{bmatrix} = \\
                = \ff_n(x_1, x_2 \oplus 1, \ldots, x_n \oplus 1) \oplus 
            \begin{bmatrix}
                0 \\
                S \oplus x_2 \\
                S \oplus x_3 \\
                \vdots \\
                S \oplus x_n \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                1 \\
                1 \\
                \vdots \\
                1 \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                n+1 \\
                n+1 \\
                \vdots \\
                n+1 \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                x_1 \\
                x_1 \\
                \vdots \\
                x_1 \\
            \end{bmatrix} = \\
            = \ff_n(x_1, x_2 \oplus 1, \ldots, x_n \oplus 1) \oplus 
            \begin{bmatrix}
                0 \\
                S \oplus x_2 \\
                S \oplus x_3 \\
                \vdots \\
                S \oplus x_n \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                n \\
                n \\
                \vdots \\
                n \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                x_1 \\
                x_1 \\
                \vdots \\
                x_1 \\
            \end{bmatrix}.
        \end{multline*}
        Аналогично, при $\ell$-м применении леммы~\ref{lemma:negation}, имеем:
        \begin{multline*}
            \ff_n(x_1, x_2, \ldots, x_{\ell-1}, x_{\ell} \oplus 1, \ldots, x_n \oplus 1) = \\
                = \ff_n(x_1, x_2, \ldots, x_{\ell}, x_{\ell+1} \oplus 1, \ldots, x_n \oplus 1) \oplus \\
        \end{multline*}
        \begin{multline*}
            \oplus
            \begin{bmatrix}
                S(x_1, \ldots, x_{\ell}, x_{\ell+1} \oplus 1, \ldots,  x_n \oplus 1) \oplus x_1 \\
                \vdots \\
                S(x_1, \ldots, x_{\ell}, x_{\ell+1} \oplus 1, \ldots,  x_n \oplus 1) \oplus x_{\ell-1} \\
                0 \\
                S(x_1, \ldots, x_{\ell}, x_{\ell+1} \oplus 1, \ldots,  x_n \oplus 1) \oplus x_{\ell+1} \oplus 1 \\
                \vdots \\
                S(x_1, \ldots, x_{\ell}, x_{\ell+1} \oplus 1, \ldots,  x_n \oplus 1) \oplus x_{n} \oplus 1 \\
            \end{bmatrix}
            \oplus 
            \begin{bmatrix}
                0 \\
                \vdots \\
                0 \\
                0 \\
                1 \\
                \vdots \\
                1 \\
            \end{bmatrix} 
            \oplus 
            \begin{bmatrix}
                x_{\ell} \\
                \vdots \\
                x_{\ell} \\
                0 \\
                x_{\ell} \\
                \vdots \\
                x_{\ell} \\
            \end{bmatrix}=\\
            = \ff_n(x_1, x_2, \ldots, x_{\ell}, x_{\ell+1} \oplus 1, \ldots, x_n \oplus 1) \oplus
            \begin{bmatrix}
                S \oplus x_1 \\
                \vdots \\
                S \oplus x_{\ell-1} \\
                0 \\
                S \oplus x_{\ell+1} \\
                \vdots \\
                S \oplus x_{n} \\
            \end{bmatrix}
            \oplus  
            \begin{bmatrix}
                n-\ell+1 \\
                \vdots \\
                n-\ell+1 \\
                0 \\
                n-\ell+1 \\
                \vdots \\
                n-\ell+1 \\
            \end{bmatrix}
            \oplus
            \begin{bmatrix}
                x_{\ell} \\
                \vdots \\
                x_{\ell} \\
                0 \\
                x_{\ell} \\
                \vdots \\
                x_{\ell} \\
            \end{bmatrix}.
    \end{multline*}
        Учитывая все полученные равенства, приходим к утверждению леммы.
    \end{proof}


    \begin{lemma}[{\cite[Лемма~6]{galatenko23}}]
    \label{lemma:weight}
        Пусть $\xx \ne \yy$, $\xx, \yy \in \EE_2^n$, $\ff_n(\xx) = \ff_n(\yy)$, тогда \(\lvert wt(\xx) - wt(\yy) \rvert = 1.\)
    \end{lemma}

    \begin{proof}
        Допустим, что среди координат $\xx$ и $\yy$ есть ровно $(n-m)$ попарно совпадающих:
        \[ 
            x_{i_1} = y_{i_1} = a_1, \ldots, x_{i_{n-m}} = y_{i_{n-m}} = a_{n-m}.
        \]
        Тогда подставим все такие координаты и перейдем к семейству: 
        \[
            \gf_m = \proj^{a_1}_{i_1} 
            \big( 
                \ldots (
                    \proj^{a_{n-m}}_{i_{n-m}}(\ff_n)
                )
                \ldots
            \big).
        \]

        По лемме~\ref{lemma:proj}, семейство $\gf_m$ имеет тот же вид, что и исходное семейство $\ff_n$, а именно, путем перестановки координат можно свести уравнение
        \[
            \gf_m(t_1, \ldots, t_{m}) = \alpha
        \]
        к уравнению
        \[
            \ff_m(s_1, \ldots, s_{m}) = \alpha'.
        \]
        Поскольку мы на первом шаге подставили все совпадающие координаты, все оставшиеся координаты являются попарно несовпадающими, и мы получаем уравнение вида:
        \[
            \ff_m(s_1, \ldots, s_{m}) = \ff_m(s_1 \oplus 1, \ldots, s_{m} \oplus 1) = \alpha'.
        \]
        Применим лемму \ref{lemma:full_negation} к значению $\ff_m(s_1 \oplus 1, \ldots, s_{m} \oplus 1)$ и рассмотрим возможные значения числа $m$ по модулю~$2$ и модулю~$4$.
        \begin{multline*}
            \ff_m(s_1 \oplus 1, \ldots, s_{m} \oplus 1) = \\
            = \ff_m(s_1, \ldots, s_m) \oplus 
                \begin{bmatrix}
                    \left ( m + \frac{m(m+1)}{2} \right ) \bmod 2\\ 
                    \left (m-1 + \frac{m(m+1)}{2} \right ) \bmod 2\\
                    \vdots \\
                    \left (1 + \frac{m(m+1)}{2} \right ) \bmod 2
                \end{bmatrix}
                \oplus 
                (m \bmod 2) \cdot 
                \begin{bmatrix}
                    S \oplus s_1 \\
                    S \oplus s_2 \\
                    \vdots \\
                    S \oplus s_m \\
                \end{bmatrix}.
        \end{multline*}
        Рассмотрим следующие случаи.
        \begin{enumerate}
            \item Случай $m \equiv 0 \mod 4$: в таком случае мы получаем тождество вида 
            \[
                (0, 0, \ldots, 0, 0) = (0, 1, \ldots, 0, 1)
            \]
            которое может выполняться только при $m = 1$, что противоречит условию. 

            \item Случай $m \equiv 1 \mod 4$: в таком случае мы получаем систему уравнений 
            \[
                S \oplus s_{i}  = i \mod 2, \; 1 \le i \le m,
            \]
            решениями которой являются наборы 
            \[
                \vv = (0, 1, \ldots, 0, 1, 0), \; \ww = (1, 0, \ldots, 1, 0, 1),
            \]
            вес которых различается на~1.

            \item Случай $m \equiv 2 \mod 4$: в таком случае мы получаем тождество вида 
            \[
                (0, 0, \ldots, 0, 0) = (1, 0, \ldots, 1, 0),
            \]
            которое не может выполняться ни при каких значениях $m$.
            
            \item Случай $m \equiv 3 \mod 4$: в таком случае мы получаем систему уравнений 
            \[
                S \oplus s_{i}  = (i+1) \mod 2, \; 1 \le i \le m,
            \]
            решениями которой являются наборы 
            \[
                \vv = (0, 1, \ldots, 0, 1, 0), \; \ww = (1, 0, \ldots, 1, 0, 1),
            \]
            вес которых различается на~1.
        \end{enumerate}

        Таким образом, мы показали, что если существуют $\xx$, $\yy$ такие, что $\ff_n(\xx) = \ff_n(\yy)$, то их вес различается ровно на 1.
    \end{proof}

    Докажем теперь следующую теорему.

    \begin{theorem}[{\cite[Теорема~6]{galatenko23}}]
        Справедливо следующее равенство:
        \[ 
            \lvert \Img(\ff_n) \rvert = 2^{n-1}.
        \]
    \end{theorem}

    \begin{proof}
        Из леммы~\ref{lemma:weight} следует, что для каждого набора $\yy \in \EE_2^n$ может быть не более двух прообразов при отображении $\xx \to \ff_n(\xx)$.
        Если мы предположим, что найдутся хотя бы три набора $\xx, \yy, \vv \in \EE_2^n$ такие, что попарные разности их весов различаются ровно на 1, то придем к противоречию: пусть без ограничения общности $wt(\xx) > wt(\yy)$, тогда $wt(\yy) = wt(\xx) - 1$, но при этом должны выполняться два равенства: 
        \[
            \lvert wt(\xx) - wt(\vv) \rvert = 1, \quad
            \lvert wt(\yy) - wt(\vv) \rvert = \lvert wt(\xx) - wt(\vv) - 1 \rvert = 1,
        \]
        что невозможно.
        Отсюда и из принципа Дирихле следует, что 
        \[
            \lvert \Img(\ff_n) \rvert \ge 2^{n-1}.
        \]
        С другой стороны, для каждого булева правильного семейства из утверждения~\ref{thm:image} следует, что
        \[
            \lvert \Img(\ff_n) \rvert \le 2^{n-1}.
        \]
        Следовательно, $\lvert \Img(\ff_n) \rvert = 2^{n-1}$.
    \end{proof}

    Рассмотрим теперь семейство~\ref{stronglyquadratic} из замечания~\ref{rem:fibo_family}.
    Напомним, что числами Люка $\lucas_n$ (см., например,~\cite[Глава~1]{vajda2008fibonacci}) называется рекуррентная последовательность, заданная соотношением:
    \[
        \lucas_n = \lucas_{n-1} + \lucas_{n-2}, \quad \lucas_0 = 2, \lucas_1 = 1.
    \]
    Нам понадобится следующее свойство чисел Люка (\cite[Глава~3]{vajda2008fibonacci}):
    \[
        \lucas_n = \fib_{n-1} + \fib_{n+1},
    \]
    где $\fib_n$~--- число Фибоначчи с индексом $n$.

    \begin{theorem}[{\cite[Теорема~7]{galatenko23}}]
        Справедливо следующее равенство:
        \[ 
            \lvert \Img(\ff_n) \rvert = \lucas_n.
        \]
    \end{theorem}

    \begin{proof}
        Рассмотрим множество $A_n$ всех двоичных строк длины~$n$ со следующим ограничением: никакие два соседних бита строки $\alpha \in A_n$ или какого-либо ее циклического сдвига не равны одновременно 1. 
        Доказательство утверждения состоит в проверке двух условий:
        \begin{itemize}
            \item уравнение $\ff_n(\xx) = \alpha$ имеет решение тогда и только тогда, когда~\mbox{$\alpha \in A_n$};
            \item множество строк $A_n$ имеет мощность $\lucas_n$.
        \end{itemize}
        Рассмотрим подробнее первое условие. Мы рассматриваем систему уравнений
        \[
            x_{i+1} \cdot \bar{x}_{i+2} = \alpha_i,
        \]
        индексы \textquote{зациклены} (после индекса $n$ идет индекс $1$).
        Для всех таких индексов $i$, что $\alpha_i = 1$, положим $x_{i+1} \coloneqq 1$, $x_{i+2} \coloneqq 0$. 
        Оставшиеся $x_j$ также положим равными нулю. 
        В таком случае мы получим $\ff_n(\xx) = \alpha$. 
        Условие на биты строки $\alpha$ используется для того, чтобы получить согласованное присваивание значений битам (исключается ситуация, когда некоторое $x_j$ должно быть равно 1 и 0 одновременно).
        Заметим также, что других решений нет: если в наборе $\alpha$ есть два соседних бита $\alpha_i = \alpha_{i+1} = 1$, то $\alpha$ не лежит в $\Img(\ff_n)$, поскольку для \textquote{соседних} функций из семейства $\ff_n$ выполняется условие $f_i(x) \cdot f_{i+1}(x) \equiv 0$.

        Рассмотрим второе условие. 
        Возьмем некоторую строку $\alpha \in A_n$. 
        Если $\alpha_1 = 0$, то необходимым и достаточным условием для $\alpha \in A_n$ будет отсутствие подстроки <<11>> в строке $(\alpha_2, \ldots, \alpha_n)$. 
        Если $\alpha_1 = 1$, то $\alpha_2 = \alpha_n = 0$, и необходимым и достаточным условием будет отсутствие подстроки <<11>> в строке $(\alpha_3, \ldots, \alpha_{n-1})$. 
        Таким образом, $\lvert A_n \rvert = \lvert B_{n-1} \rvert + \lvert B_{n-3} \rvert$, где $B_n$~---~множество двоичных строк длины $n$, не содержащих подстроку <<11>>. 
        Хорошо известно (см., например,~\cite[Раздел~1.5]{Zuev}), что число элементов $\lvert B_n \rvert = \fib_{n+2}$. 
        В таком случае 
        \[
            \lvert A_n \rvert = \fib_{n+1} + \fib_{n-1} = \lucas_n,
        \]
        что и требовалось доказать.
    \end{proof}

    \begin{corollary}[{\cite[Следствие~2]{galatenko23}}]
        Для $\lvert \Img(\ff_n) \rvert$ верна формула:
        \[ 
            \lvert \Img(\ff_n) \rvert = \lfloor \varphi^n \rceil, 
        \]    
        где $\varphi = \frac{1 + \sqrt{5}}{2}$~--- пропорция золотого сечения, а $\lfloor \cdot \rceil$~--- операция взятия ближайшего целого числа.
    \end{corollary}


\section{О группе подстановок, порождаемых правильными семействами}
\label{sec:algprop}

    В настоящем разделе мы будем рассматривать свойства множества подстановок $\sprop$, порожденных правильными семействами функций $\ff$.

    \begin{definition}
        Пусть $\ff_n$~--- правильное семейство размера $n$ на $Q^n$, где $(Q, \circ)$~--- квазигруппа.
        Рассмотрим отображение:
        \[ 
            \sigma_{\ff}(\xx) \colon \xx \to \xx \circ \ff(\xx),
            \quad
            \begin{bmatrix}
                x_1 \\
                \vdots \\
                x_n
            \end{bmatrix} 
            \to 
            \begin{bmatrix}
                x_1 \circ f_1(\xx) \\
                \vdots \\
                x_n \circ f_n(\xx)
            \end{bmatrix}.
        \]
        Это отображение является подстановкой на множестве $Q^n$ (см. теорему~\ref{propos:bijection}): $\sigma_{\ff} \in \SSS_{Q^n}$.
        Будем через $\sprop$ обозначать множество таких подстановок $\sigma \in \SSS_{Q^n}$, что отображение $\ff_n$ вида
        \[
            \ff_n(\xx) = 
            L_{\xx}^{-1} \left( \sigma(\xx) \right) = 
            \begin{bmatrix}
                L_{x_1}^{-1}(\sigma_1(\xx)) \\
                \vdots \\
                L_{x_n}^{-1}(\sigma_n(\xx)) \\
            \end{bmatrix},
        \]
        где $L_{x}(y) = x \circ y$, является правильным на $Q^n$.
    \end{definition}


\subsection{Замкнутость относительно инверсии подстановки}
\label{sec:properinverse}

    Пусть $\sigma \in \sprop$~--- подстановка, порожденная некоторым правильным семейством $\ff$ на $Q^n$.
    Покажем, что если $Q$ является группой, то $\sigma \in \sprop$ тогда и только тогда, когда $\sigma^{-1} \in \sprop$.
    Другими словами, $\sprop$ замкнуто относительно взятия обратного элемента (в случае, когда $Q = \GGG$~--- группа).

    \begin{theorem}[{\cite[Теорема~1]{sibecrypt23}}]
        Пусть $\ff$~--- правильное семейство на $\GGG^n$, $(\GGG, \cdot)$~--- группа.
        Рассмотрим \textit{дуальное} к семейству $\ff$ семейство $\gf$, соответствующее подстановке $\sigma^{-1}$:
        \[
            \gf \colon Q^n \to Q^n, \quad \gf(\xx) = \xx \cdot \sigma^{-1}(\xx).
        \]
        Тогда $\gf(\xx)$ также является правильным на $Q^n$.
    \end{theorem}

    \begin{proof}
        Необходимо доказать, что для любых наборов $\xx \ne \yy$, $\xx, \yy \in \GGG^n$ существует такой индекс $i$, что $x_i \ne y_i$, но $\gf(\xx)[i] = \gf(\yy)[i]$.
        Возьмем два набора $\xx, \yy \in Q^n$, $\xx \ne \yy$.
        Поскольку $\sigma_{\ff}$ является подстановкой, то найдутся $\vv, \ww \in \GGG^n$ такие, что 
        \[
            \xx = \sigma_{\ff}(\vv) = \vv \cdot \ff(\vv), \yy = \sigma_{\ff}(\ww) = \ww \cdot \ff(\ww).
        \]
        Из условия $\xx \ne \yy$ следует неравенство $\vv \ne \ww$, а значит, по свойству правильности семейства $\ff$ найдется такой индекс $i$, что $v_i \ne w_i$, но $\ff(\vv)[i] = \ff(\ww)[i]$.
        В таком случае 
        \[
            x_i = v_i \cdot f_i(\vv) \ne y_i = w_i \cdot f_i(\ww).
        \]
        Поскольку $\sigma_{\ff}(\uu) = \uu \cdot \ff(\uu)$, то по определению семейства $\gf$, имеем:
        \[
            \uu = \sigma_{\ff}^{-1}(\uu \cdot \ff(\uu)) = \left( \uu \cdot \ff(\uu) \right) \cdot \gf(\uu \cdot \ff(uu)),
        \] 
        откуда следует уравнение на $\gf$:
        \[
            \gf(\uu \cdot \ff(\uu)) = \ff(\uu)^{-1},
        \]
        где через $\ff^{-1}(t)$ обозначен обратный элемент к $\ff(t)$ в группе $\GGG^n$.
        Подставим вместо $\uu$ значения $\vv$ и $\ww$ и рассмотрим $i$-ю координату полученного вектора:
        \[
            \gf_i(\xx) = \gf_i(\vv \cdot \ff(\vv)) = f_i(\vv)^{-1} = \\
            = f_i(\ww)^{-1} = g_i(\ww \cdot \ff(\ww)) = g_i(\yy),
        \]
        что и требовалось доказать.
    \end{proof}

    \TODO{Верно ли утверждение для обобщенно правильных??}

    \begin{remark}
        При доказательстве утверждения мы пользовались ассоциативностью операции $(\cdot)$ на множестве $Q^n = \GGG^n$; в общем случае из уравнения
        \[ 
            \uu = (\uu \circ \ff(\uu)) \circ \gf(\uu \circ \ff(\uu))    
        \]
        не следует, что $G(\uu \circ \ff(\uu)) = inv(\ff(\uu))$, где через $inv(\ff(\uu))$ обозначен \textit{левый обратный} к элементу $\ff(\uu)$, через $\circ$~--- некоторая бинарная операция.
    \end{remark}

    \TODO{Есть ли контрпример?}



\subsection{Неподвижные точки}

    Покажем, что подстановки $\pi_{\ff} \in \sprop$ для булевых правильных семейств $\ff$ всегда имеют четкое число неподвижных точек.
    Для этого докажем более общее утверждение относительно преобразований вида $\xx \to x \oplus \Phi(\ff(\xx))$.

    \begin{theorem}[{\cite[Следствие~1]{dm21}}]
    \label{thm:propermaps}
        Пусть $\ff_n$~--- правильное семейство на $\ZZ_2^n$.
        Отображение на множестве $\ZZ_2^n$, задаваемое формулой
        \begin{gather*}
            \xx \to \xx \oplus \Phi(\ff_n(\xx)), \\
            \begin{bmatrix}
                x_1 \\
                \vdots \\
                x_n
            \end{bmatrix}
            \to
            \begin{bmatrix}
                x_1    \\
                \vdots \\
                x_n    \\
            \end{bmatrix}
            \oplus \Phi \left(
            \begin{bmatrix}
                f_1(x_1, \ldots, x_n) \\
                \vdots \\
                f_n(x_1, \ldots, x_n) \\
            \end{bmatrix}
            \right),
        \end{gather*}
        где $\Phi$~---~произвольное отображение вида $\Phi \colon \ZZ_2^n \to \ZZ_2^n$, имеет четное число неподвижных точек.
    \end{theorem}

    \begin{proof}
        Неподвижные точки указанного отображения удовлетворяют уравнению
        \[
            \xx = \xx \oplus \Phi(\ff_n(\xx)),
        \]
        следовательно $\xx$~--- неподвижная точка тогда и только тогда, когда $\ff(\xx) \in \Phi^{-1}(0^n)$.
        Для каждой точки $\alpha$, попавшей в указанный прообраз, по теореме~\ref{thm:preimage} имеется четное число решений уравнения $\ff(\xx) = \alpha$.
    \end{proof}

    \begin{remark}
        Теорема~\ref{thm:propermaps} выполняется не только для $\ZZ_2^n$, но и для любой лупы $Q^n$, $\lvert Q \rvert = 2$.
    \end{remark}


\subsection{Транзитивность}

    Покажем, что замыкание множества $\sprop$ действует транзитивно на множестве $Q^n$, т.е. для любых $\alpha, \beta \in Q^n$ существует такой набор правильных семейств $\ff_1, \ldots, \ff_n$, что 
    \[
        \beta = \pi_{\ff_n} \left( \ldots \pi_{\ff_1} \left( \alpha \right) \ldots \right).
    \]
    \begin{theorem}
        Пусть $Q$~--- квазигруппа.
        Рассмотрим множество подстановок $\sprop$, порождаемых правильными семействами функций на $Q^n$.
        Тогда замыкание множества подстановок $\langle \sprop \rangle$ действует транзитивно на $Q^n$.
    \end{theorem}

    \begin{proof}
        Пусть $\alpha$, $\beta$~--- элементы $Q^n$ на расстоянии Хэмминга 1 друг от друга (т.е. $\exists i \colon \alpha_i \ne \beta_i$, и $\alpha_j = \beta_j$, $j \ne i$).
        Покажем, что элемент $\alpha$ может быть переведен некоторой подстановкой $\sigma_{\ff} \in \sprop$ в элемент $\beta$.
        Рассмотрим такой элемент $c$, что $\alpha_i \circ c = \beta_i$, а также элементы $e_j$, $j \ne i$, такие что $\alpha_j \circ e_j = \alpha_j$.
        Зададим следующее треугольное семейство $\ff_n$:
        \[
            \ff_n = 
            \begin{bmatrix}
                e_1 \\
                \vdots \\
                e_{i-1} \\
                f(x_1, \ldots, x_{i-1}, x_{i+1}, \ldots, x_n) \\
                e_{i+1} \\
                \vdots \\
                e_n 
            \end{bmatrix},
        \]
        где $f(\alpha_1, \ldots, \alpha_{i-1}, \alpha_{i+1}, \ldots, \alpha_n) = c$, для всех остальных наборов $f$ задана произвольным образом.
        В таком случае мы имеем:
        \[
            \sigma_{\ff}(\alpha) = \alpha \circ \ff(\alpha) = 
            \begin{bmatrix}
                \alpha_1 \circ e_1 \\
                \vdots \\
                \alpha_{i-1} \circ e_{i-1} \\
                \alpha_i \circ c \\
                \alpha_{i+1} \circ e_{i+1} \\
                \vdots \\
                \alpha_{n} \circ e_n \\
            \end{bmatrix} = \beta,
        \]
        следовательно, $\sigma_{\ff}(\alpha) = \beta$.
        Перевод элемента $\alpha$ в $\beta$, находящие на расстоянии Хэмминга более 1, проводится последовательными сдвигами.
    \end{proof}

\subsection{Группа, порождаемая подстановками $\sigma_{\ff}$}

    Для $\EE_2^n$ имеем 
    \[
        \langle \sprop \rangle = \SSS_{\EE_2^n}.
    \]


\section*{Выводы}

    В настоящей главе были рассмотрены некоторые свойства правильных семейств.
    \begin{enumerate}
        \item Было показано, что отображения, сохраняющие множество правильных семейств, являются изометриями соответствующего пространства Хэмминга.
        \item Было показано, что для булевых правильных семейств прообраз любой точки имеет четную мощность.
        \item Были подсчитаны мощности образов отображений, задаваемых некоторыми правильными булевыми семействами.
        \item Было показано, что множество \textquote{правильных подстановок} замкнуто относительно операции обращения подстановки (для семейств над прямыми произведениями групп), замыкание множества \textquote{правильных подстановок} действует транзитивно на множестве $Q^n$, в случае $Q = \EE_2$ было показано, что \textquote{правильные подстановки} имеют четное число неподвижных точек.
    \end{enumerate}